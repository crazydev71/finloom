/*
    *
    * Wijmo Library 5.20172.359
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */
"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),_Tally,_PivotKey,_PivotNode,PivotCollectionView,PivotField,CubePivotField,DimensionType,PivotFieldCollection,PivotFilter,PivotFieldEditor,PivotFilterEditor,ShowTotals,ShowAs,PivotEngine,ProgressEventArgs,_ServerConnection,_ServerTally,_ListContextMenu,PivotPanel,_GridContextMenu,_PivotMergeManager,PivotGrid,DetailDialog,PivotChartType,LegendVisibility,PivotChart;Object.defineProperty(exports,"__esModule",{value:!0});var wjcCore=require("wijmo/wijmo"),wjcGridFilter=require("wijmo/wijmo.grid.filter"),wjcInput=require("wijmo/wijmo.input"),wjcGrid=require("wijmo/wijmo.grid"),wjcChart=require("wijmo/wijmo.chart"),wjcSelf=require("wijmo/wijmo.olap");window.wijmo=window.wijmo||{};window.wijmo.olap=wjcSelf;_Tally=function(){function n(){this._cnt=0;this._cntn=0;this._sum=0;this._sum2=0;this._min=null;this._max=null;this._first=null;this._last=null}return n.prototype.add=function(t,i){t instanceof n?(this._sum+=t._sum,this._sum2+=t._sum2,this._max=this._max&&t._max?Math.max(this._max,t._max):this._max||t._max,this._min=this._min&&t._min?Math.min(this._min,t._min):this._min||t._min,this._cnt+=t._cnt,this._cntn+=t._cntn):t!=null&&(this._cnt++,wjcCore.isBoolean(t)&&(t=t?1:0),(this._min==null||t<this._min)&&(this._min=t),(this._max==null||t>this._max)&&(this._max=t),this._first==null&&(this._first=t),this._last=t,wjcCore.isNumber(t)&&!isNaN(t)&&(wjcCore.isNumber(i)&&(t*=i),this._cntn++,this._sum+=t,this._sum2+=t*t))},n.prototype.getAggregate=function(n){if(this._cnt==0)return null;var t=this._cntn==0?0:this._sum/this._cntn;switch(n){case wjcCore.Aggregate.Avg:return t;case wjcCore.Aggregate.Cnt:return this._cnt;case wjcCore.Aggregate.Max:return this._max;case wjcCore.Aggregate.Min:return this._min;case wjcCore.Aggregate.Rng:return this._max-this._min;case wjcCore.Aggregate.Sum:return this._sum;case wjcCore.Aggregate.VarPop:return this._cntn<=1?0:this._sum2/this._cntn-t*t;case wjcCore.Aggregate.StdPop:return this._cntn<=1?0:Math.sqrt(this._sum2/this._cntn-t*t);case wjcCore.Aggregate.Var:return this._cntn<=1?0:(this._sum2/this._cntn-t*t)*this._cntn/(this._cntn-1);case wjcCore.Aggregate.Std:return this._cntn<=1?0:Math.sqrt((this._sum2/this._cntn-t*t)*this._cntn/(this._cntn-1));case wjcCore.Aggregate.First:return this._first;case wjcCore.Aggregate.Last:return this._last}throw'Invalid aggregate type.';},n}();exports._Tally=_Tally;_PivotKey=function(){function n(n,t,i,r,u){this._fields=n;this._fieldCount=t;this._valueFields=i;this._valueFieldIndex=r;this._item=u}return Object.defineProperty(n.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"valueFields",{get:function(){return this._valueFields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"values",{get:function(){var n,t;if(this._vals==null)for(this._vals=new Array(this._fieldCount),n=0;n<this._fieldCount;n++)t=this._fields[n],this._vals[n]=t._getValue(this._item,!1);return this._vals},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fieldNames",{get:function(){var n,t;if(!this._names)for(this._names=[],n=0;n<this.fields.length;n++)t=this._fields[n],this._names.push(t._getName());return this._names},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"aggregate",{get:function(){var n=this._valueFields,t=this._valueFieldIndex;return wjcCore.assert(n&&t>-1&&t<n.length,'aggregate not available for this key'),n[t].aggregate},enumerable:!0,configurable:!0}),n.prototype.getValue=function(n,t){var i,r,u;return this.values.length==0?wjcCore.culture.olap.PivotEngine.grandTotal:n>this.values.length-1?wjcCore.culture.olap.PivotEngine.subTotal:(i=this.values[n],t&&!wjcCore.isString(i)&&(r=this.fields[n],u=r?r.format:'',i=wjcCore.Globalize.format(this.values[n],u)),i)},n.prototype.compareTo=function(n){var t=0,i,o,v;if(n!=null&&n._fields==this._fields){var e=this.values,s=n.values,y=Math.min(e.length,s.length);for(i=0;i<y;i++){var p=e[i]!=null?wjcCore.getType(e[i]):null,r=e[i],u=s[i],f=this._fields[i];if(f.sortComparer&&(t=f.sortComparer(r,u),wjcCore.isNumber(t))){if(t!=0)return f.descending?-t:t;continue}if(p==wjcCore.DataType.Date&&(o=f.format,o&&o!='d'&&o!='D')){var h=f._getValue(this._item,!0),c=f._getValue(n._item,!0),l=wjcCore.Globalize.parseDate(h,o),a=wjcCore.Globalize.parseDate(c,o);l&&a?(r=l,u=a):(r=h,u=c)}if(v=r==u||wjcCore.DateTime.equals(r,u),!v)return r==null?1:u==null?-1:(t=r<u?-1:1,f.descending?-t:t)}if(e.length==s.length&&(t=this._valueFieldIndex-n._valueFieldIndex,t!=0))return t;if(t=s.length-e.length,t!=0)return t*(this.fields.engine.totalsBeforeData?-1:1)}return 0},n.prototype.matchesItem=function(n){for(var i,r,t=0;t<this._vals.length;t++)if(i=this.getValue(t,!0),r=this._fields[t]._getValue(n,!0),i!=r)return!1;return!0},n.prototype.toString=function(){var n,t,i,r;if(!this._key){for(n='',t=0;t<this._fieldCount;t++)i=this._fields[t],n+=i._getName()+':'+i._getValue(this._item,!0)+';';this._valueFields?(r=this._valueFields[this._valueFieldIndex],n+=r._getName()+':0;'):n+='{total}';this._key=n}return this._key},n}();_PivotKey._ROW_KEY_NAME='$rowKey';exports._PivotKey=_PivotKey;_PivotNode=function(){function n(n,t,i,r,u,f){this._key=new _PivotKey(n,t,i,r,u);this._nodes={};this._parent=f}return n.prototype.getNode=function(t,i,r,u,f){for(var s,e,o=this,h=0;h<i;h++)s=t[h]._getValue(f,!0),e=o._nodes[s],e||(e=new n(t,h+1,r,u,f,o),o._nodes[s]=e),o=e;return r&&u>-1&&(s=r[u].header,e=o._nodes[s],e||(e=new n(t,i,r,u,f,o),o._nodes[s]=e),o=e),o},Object.defineProperty(n.prototype,"key",{get:function(){return this._key},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tree",{get:function(){return this._tree||(this._tree=new n(null,0,null,-1,null)),this._tree},enumerable:!0,configurable:!0}),n}();exports._PivotNode=_PivotNode;PivotCollectionView=function(n){function t(t){var i=n.call(this)||this;return i._ng=wjcCore.asType(t,PivotEngine,!1),i}return __extends(t,n),Object.defineProperty(t.prototype,"engine",{get:function(){return this._ng},enumerable:!0,configurable:!0}),t.prototype._performSort=function(t){for(var r,f,u,e=this._ng,i=0;i<t.length;i++)if(!(this._getRowLevel(t,i)>-1)){for(r=i;r<t.length-1;r++)if(this._getRowLevel(t,r+1)>-1)break;if(r>i)for(f=t.slice(i,r+1),n.prototype._performSort.call(this,f),u=0;u<f.length;u++)t[i+u]=f[u];i=r}},t.prototype._getRowLevel=function(n,t){var i=n[t],r=i?i[_PivotKey._ROW_KEY_NAME]:null;return this._ng._getRowLevel(r)},t}(wjcCore.CollectionView);exports.PivotCollectionView=PivotCollectionView;PivotField=function(){function n(n,t,i,r){this.propertyChanged=new wjcCore.Event;this._ng=n;this._binding=new wjcCore.Binding(t);this._header=i?i:wjcCore.toHeaderCase(t);this._aggregate=wjcCore.Aggregate.Sum;this._showAs=ShowAs.NoCalculation;this._isContentHtml=!1;this._format='';this._filter=new PivotFilter(this);r&&wjcCore.copy(this,r)}return Object.defineProperty(n.prototype,"binding",{get:function(){return this._binding?this._binding.path:null},set:function(n){var r,i,t,u,f;if(n!=this.binding){r=this.binding;i=wjcCore.asString(n);this._binding=i?new wjcCore.Binding(i):null;!this._dataType&&this._ng&&this._binding&&(t=this._ng.collectionView,t&&t.sourceCollection&&t.sourceCollection.length&&(u=t.sourceCollection[0],this._dataType=wjcCore.getType(this._binding.getValue(u))));f=new wjcCore.PropertyChangedEventArgs('binding',r,n);this.onPropertyChanged(f)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"header",{get:function(){return this._header},set:function(n){n=wjcCore.asString(n,!1);var t=this._ng.fields.getField(n);!n||t&&t!=this?wjcCore.assert(!1,'field headers must be unique and non-empty.'):this._setProp('_header',wjcCore.asString(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"aggregate",{get:function(){return this._aggregate},set:function(n){this._setProp('_aggregate',wjcCore.asEnum(n,wjcCore.Aggregate))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"showAs",{get:function(){return this._showAs},set:function(n){this._setProp('_showAs',wjcCore.asEnum(n,ShowAs))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"weightField",{get:function(){return this._weightField},set:function(t){this._setProp('_weightField',wjcCore.asType(t,n,!0))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dataType",{get:function(){return this._dataType},set:function(n){this._setProp('_dataType',wjcCore.asEnum(n,wjcCore.DataType))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"format",{get:function(){return this._format},set:function(n){this._setProp('_format',wjcCore.asString(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this._width},set:function(n){this._setProp('_width',wjcCore.asNumber(n,!0,!0))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"wordWrap",{get:function(){return this._wordWrap},set:function(n){this._setProp('_wordWrap',wjcCore.asBoolean(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"descending",{get:function(){return this._descending?!0:!1},set:function(n){this._setProp('_descending',wjcCore.asBoolean(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isContentHtml",{get:function(){return this._isContentHtml},set:function(n){this._setProp('_isContentHtml',wjcCore.asBoolean(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sortComparer",{get:function(){return this._srtCmp},set:function(n){n!=this.sortComparer&&(this._srtCmp=wjcCore.asFunction(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"engine",{get:function(){return this._ng},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"collectionView",{get:function(){return this.engine?this.engine.collectionView:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isActive",{get:function(){return this._getIsActive()},set:function(n){this._setIsActive(n)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"parentField",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"key",{get:function(){return this.header},enumerable:!0,configurable:!0}),n.prototype.onPropertyChanged=function(n){this.propertyChanged.raise(this,n);this._ng._fieldPropertyChanged(this,n)},n.prototype._getIsActive=function(){var i,n,r,t;if(this._ng)for(i=this._ng._viewLists,n=0;n<i.length;n++)for(r=i[n],t=0;t<r.length;t++)if(r[t].binding==this.binding)return!0;return!1},n.prototype._setIsActive=function(n){var o,e,r,u,f,t,i;if(this._ng&&(o=this.isActive,n=wjcCore.asBoolean(n),n!=o))if(n)this.dataType==wjcCore.DataType.Number?this._ng.valueFields.push(this):this._ng.rowFields.push(this);else{for(e=this._ng._viewLists,r=0;r<e.length;r++)for(u=e[r],t=0;t<u.length;t++)i=u[t],(i==this||i.parentField==this)&&(u.removeAt(t),t--);for(f=this._ng.fields,t=f.length-1;t>=0;t--)i=f[t],i.parentField==this&&(f.removeAt(t),t--)}},n.prototype._clone=function(){var t=new n(this._ng,this.binding),u,i,r;for(this._ng._copyProps(t,this,n._props),t._autoGenerated=!0,t._parent=this,u=this.header.replace(/\d+$/,''),i=2;;i++)if(r=u+i.toString(),this._ng.fields.getField(r)==null){t._header=r;break}return t},n.prototype._setProp=function(n,t){var i=this[n],r;if(t!=i){this[n]=t;r=new wjcCore.PropertyChangedEventArgs(n.substr(1),i,t);this.onPropertyChanged(r)}},n.prototype._getName=function(){return this.header||this.binding},n.prototype._getValue=function(n,t){var i=this._binding._key?n[this._binding._key]:this._binding.getValue(n);return!t||typeof i=='string'?i:wjcCore.Globalize.format(i,this._format)},n.prototype._getWeight=function(n){var t=this._weightField?this._weightField._getValue(n,!1):null;return wjcCore.isNumber(t)?t:null},n}();PivotField._props=['dataType','format','width','wordWrap','aggregate','showAs','descending','isContentHtml'];exports.PivotField=PivotField;CubePivotField=function(n){function t(t,i,r,u){var f=n.call(this,t,i,r,u)||this,e=f.binding!=null&&i.length>0;return f.subFields!=null&&f.subFields.length>0?wjcCore.assert(!e,'Fields with sub-fields should not have bindings.'):wjcCore.assert(e,'Fields without sub-fields should have bindings.'),f}return __extends(t,n),Object.defineProperty(t.prototype,"header",{get:function(){return this._header},set:function(n){this._setProp('_header',wjcCore.asString(n))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dimensionType",{get:function(){return this._dimensionType},set:function(n){this._setProp('_dimensionType',wjcCore.asEnum(n,DimensionType,!1))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subFields",{get:function(){return this._subFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"key",{get:function(){return this.binding},enumerable:!0,configurable:!0}),t.prototype._clone=function(){throw'CubePivotField objects cannot be cloned';},t.prototype._copy=function(n,t){var i=this;return n=='subFields'?(this._subFields?this._subFields.splice(0,this._subFields.length):this._subFields=[],t&&t.length&&t.forEach(function(n){var t=i.engine._createField(n,i._autoGenerated);i._subFields.push(t)}),!0):!1},t.prototype._getIsActive=function(){return this.subFields&&this.subFields.length?!1:n.prototype._getIsActive.call(this)},t.prototype._setIsActive=function(t){this.subFields&&this.subFields.length||n.prototype._setIsActive.call(this,t)},t}(PivotField);exports.CubePivotField=CubePivotField,function(n){n[n.Dimension=0]="Dimension";n[n.Measure=1]="Measure";n[n.Kpi=2]="Kpi";n[n.NameSet=3]="NameSet";n[n.Attribute=4]="Attribute";n[n.Folder=5]="Folder";n[n.Hierarchy=6]="Hierarchy";n[n.Date=7]="Date";n[n.Currency=8]="Currency"}(DimensionType=exports.DimensionType||(exports.DimensionType={}));PivotFieldCollection=function(n){function t(t){var i=n.call(this)||this;return i._ng=t,i}return __extends(t,n),Object.defineProperty(t.prototype,"maxItems",{get:function(){return this._maxItems},set:function(n){this._maxItems=wjcCore.asInt(n,!0,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"engine",{get:function(){return this._ng},enumerable:!0,configurable:!0}),t.prototype.getField=function(n){return this._getField(this,n)},t.prototype._getField=function(n,t){for(var i,r=0;r<n.length;r++)if((i=n[r],i.key==t)||i instanceof CubePivotField&&i.subFields&&(i=this._getField(i.subFields,t),i))return i;return null},t.prototype.push=function(){for(var u,f,t,i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];for(u=this._ng,f=0;i&&f<i.length;f++){if(t=i[f],wjcCore.isString(t)&&(t=this==u.fields?new PivotField(u,t):u.fields.getField(t)),wjcCore.assert(t instanceof PivotField,'This collection must contain PivotField objects only.'),t.key&&this.getField(t.key))return wjcCore.assert(!1,'PivotField keys must be unique.'),-1;if(this._maxItems!=null&&this.length>=this._maxItems)break;n.prototype.push.call(this,t)}return this.length},t}(wjcCore.ObservableArray);exports.PivotFieldCollection=PivotFieldCollection;PivotFilter=function(){function n(n){this._fld=n;var t=n;this._valueFilter=new wjcGridFilter.ValueFilter(t);this._conditionFilter=new wjcGridFilter.ConditionFilter(t)}return Object.defineProperty(n.prototype,"filterType",{get:function(){return this._filterType!=null?this._filterType:this._fld.engine.defaultFilterType},set:function(n){n!=this._filterType&&(this._filterType=wjcCore.asEnum(n,wjcGridFilter.FilterType,!0),this.clear())},enumerable:!0,configurable:!0}),n.prototype.apply=function(n){return this._conditionFilter.apply(n)&&this._valueFilter.apply(n)},Object.defineProperty(n.prototype,"isActive",{get:function(){return this._conditionFilter.isActive||this._valueFilter.isActive},enumerable:!0,configurable:!0}),n.prototype.clear=function(){var n=!1;if(this._valueFilter.isActive&&(this._valueFilter.clear(),n=!0),this._conditionFilter.isActive&&(this._valueFilter.clear(),n=!0),n)this._fld.onPropertyChanged(new wjcCore.PropertyChangedEventArgs('filter',null,null))},Object.defineProperty(n.prototype,"valueFilter",{get:function(){return this._valueFilter},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"conditionFilter",{get:function(){return this._conditionFilter},enumerable:!0,configurable:!0}),n}();exports.PivotFilter=PivotFilter;wjcCore.culture.olap=wjcCore.culture.olap||{};wjcCore.culture.olap.PivotFieldEditor=window.wijmo.culture.olap.PivotFieldEditor||{dialogHeader:'Field settings:',header:'Header:',summary:'Summary:',showAs:'Show As:',weighBy:'Weigh by:',sort:'Sort:',filter:'Filter:',format:'Format:',sample:'Sample:',edit:'Edit...',clear:'Clear',ok:'OK',cancel:'Cancel',none:'(none)',sorts:{asc:'Ascending',desc:'Descending'},aggs:{sum:'Sum',cnt:'Count',avg:'Average',max:'Max',min:'Min',rng:'Range',std:'StdDev',var:'Var',stdp:'StdDevPop',varp:'VarPop',first:'First',last:'Last'},calcs:{noCalc:'No calculation',dRow:'Difference from previous row',dRowPct:'% Difference from previous row',dCol:'Difference from previous column',dColPct:'% Difference from previous column',dPctGrand:'% of grand total',dPctRow:'% of row total',dPctCol:'% of column total',dRunTot:'Running total',dRunTotPct:'% running total'},formats:{n0:'Integer (n0)',n2:'Float (n2)',c:'Currency (c)',p0:'Percentage (p0)',p2:'Percentage (p2)',n2c:'Thousands (n2,)',n2cc:'Millions (n2,,)',n2ccc:'Billions (n2,,,)',d:'Date (d)',MMMMddyyyy:'Month Day Year (MMMM dd, yyyy)',dMyy:'Day Month Year (d/M/yy)',ddMyy:'Day Month Year (dd/M/yy)',dMyyyy:'Day Month Year (dd/M/yyyy)',MMMyyyy:'Month Year (MMM yyyy)',MMMMyyyy:'Month Year (MMMM yyyy)',yyyy:'Year (yyyy)',yyyyQq:'Year Quarter (yyyy "Q"q)',FYEEEEQU:'Fiscal Year Quarter ("FY"EEEE "Q"U)'}};PivotFieldEditor=function(n){function t(t,i){var r=n.call(this,t,null,!0)||this,f,u;return wjcCore.assert(wjcInput!=null,"Missing dependency: PivotFieldEditor requires wijmo.input."),r.hostElement.tabIndex=-1,f=r.getTemplate(),r.applyTemplate('wj-control wj-content wj-pivotfieldeditor',f,{_dBnd:'sp-bnd',_dHdr:'div-hdr',_dAgg:'div-agg',_dShw:'div-shw',_dWFl:'div-wfl',_dSrt:'div-srt',_btnFltEdt:'btn-flt-edt',_btnFltClr:'btn-flt-clr',_dFmt:'div-fmt',_dSmp:'div-smp',_btnApply:'btn-apply',_btnCancel:'btn-cancel',_gDlg:'g-dlg',_gHdr:'g-hdr',_gAgg:'g-agg',_gShw:'g-shw',_gWfl:'g-wfl',_gSrt:'g-srt',_gFlt:'g-flt',_gFmt:'g-fmt',_gSmp:'g-smp'}),r._pvDate=new Date,u=wjcCore.culture.olap.PivotFieldEditor,r._gDlg.textContent=u.dialogHeader,r._gHdr.textContent=u.header,r._gAgg.textContent=u.summary,r._gShw.textContent=u.showAs,r._gWfl.textContent=u.weighBy,r._gSrt.textContent=u.sort,r._gFlt.textContent=u.filter,r._gFmt.textContent=u.format,r._gSmp.textContent=u.sample,r._btnFltEdt.textContent=u.edit,r._btnFltClr.textContent=u.clear,r._btnApply.textContent=u.ok,r._btnCancel.textContent=u.cancel,r._cmbHdr=new wjcInput.ComboBox(r._dHdr),r._cmbAgg=new wjcInput.ComboBox(r._dAgg),r._cmbShw=new wjcInput.ComboBox(r._dShw),r._cmbWFl=new wjcInput.ComboBox(r._dWFl),r._cmbSrt=new wjcInput.ComboBox(r._dSrt),r._cmbFmt=new wjcInput.ComboBox(r._dFmt),r._cmbSmp=new wjcInput.ComboBox(r._dSmp),r._initAggregateOptions(),r._initShowAsOptions(),r._initFormatOptions(),r._initSortOptions(),r._cmbShw.textChanged.addHandler(r._updateFormat,r),r._cmbFmt.textChanged.addHandler(r._updatePreview,r),r.addEventListener(r._btnFltEdt,'click',function(n){r._editFilter();n.preventDefault()}),r.addEventListener(r._btnFltClr,'click',function(n){wjcCore.enable(r._btnFltClr,!1);r._createFilterEditor();setTimeout(function(){r._eFlt.clearEditor()});n.preventDefault()}),r.addEventListener(r._btnApply,'click',function(){r.updateField()}),r.initialize(i),r}return __extends(t,n),Object.defineProperty(t.prototype,"field",{get:function(){return this._fld},set:function(n){n!=this._fld&&(this._fld=wjcCore.asType(n,PivotField),this.updateEditor())},enumerable:!0,configurable:!0}),t.prototype.updateEditor=function(){if(this._fld){this._dBnd.textContent=this._fld.binding;this._cmbHdr.text=this._fld.header;this._cmbAgg.collectionView.refresh();this._cmbAgg.selectedValue=this._fld.aggregate;this._cmbSrt.selectedValue=this._fld.descending;this._cmbShw.selectedValue=this._fld.showAs;this._initWeighByOptions();wjcCore.enable(this._btnFltClr,this._fld.filter.isActive);this._cmbFmt.collectionView.refresh();this._cmbFmt.selectedValue=this._fld.format;this._cmbFmt.selectedValue||(this._cmbFmt.text=this._fld.format);var n=this._fld instanceof CubePivotField;this._cmbAgg.isDisabled=n;this._cmbWFl.isDisabled=n}},t.prototype.updateField=function(){if(this._fld){var n=this._cmbHdr.text.trim();this._fld.header=n?n:wjcCore.toHeaderCase(this._fld.binding);this._fld.aggregate=this._cmbAgg.selectedValue;this._fld.showAs=this._cmbShw.selectedValue;this._fld.weightField=this._cmbWFl.selectedValue;this._fld.descending=this._cmbSrt.selectedValue;this._eFlt&&this._eFlt.updateFilter();this._fld.format=this._cmbFmt.selectedValue||this._cmbFmt.text}},t.prototype._initAggregateOptions=function(){var i=this,n=wjcCore.culture.olap.PivotFieldEditor.aggs,t=wjcCore.Aggregate,r=[{key:n.sum,val:t.Sum,all:!1},{key:n.cnt,val:t.Cnt,all:!0},{key:n.avg,val:t.Avg,all:!1},{key:n.max,val:t.Max,all:!0},{key:n.min,val:t.Min,all:!0},{key:n.rng,val:t.Rng,all:!1},{key:n.std,val:t.Std,all:!1},{key:n.var,val:t.Var,all:!1},{key:n.stdp,val:t.StdPop,all:!1},{key:n.varp,val:t.VarPop,all:!1},{key:n.first,val:t.First,all:!0},{key:n.last,val:t.Last,all:!0},];this._cmbAgg.itemsSource=r;this._cmbAgg.collectionView.filter=function(n){if(n&&n.all)return!0;if(i._fld){var t=i._fld.dataType;return t==wjcCore.DataType.Number||t==wjcCore.DataType.Boolean}return!1};this._cmbAgg.initialize({displayMemberPath:'key',selectedValuePath:'val'})},t.prototype._initShowAsOptions=function(){var n=wjcCore.culture.olap.PivotFieldEditor.calcs,t=[{key:n.noCalc,val:ShowAs.NoCalculation},{key:n.dRow,val:ShowAs.DiffRow},{key:n.dRowPct,val:ShowAs.DiffRowPct},{key:n.dCol,val:ShowAs.DiffCol},{key:n.dColPct,val:ShowAs.DiffColPct},{key:n.dPctGrand,val:ShowAs.PctGrand},{key:n.dPctRow,val:ShowAs.PctRow},{key:n.dPctCol,val:ShowAs.PctCol},{key:n.dRunTot,val:ShowAs.RunTot},{key:n.dRunTotPct,val:ShowAs.RunTotPct}];this._cmbShw.itemsSource=t;this._cmbShw.initialize({displayMemberPath:'key',selectedValuePath:'val'})},t.prototype._initFormatOptions=function(){var t=this,n=wjcCore.culture.olap.PivotFieldEditor.formats,i=[{key:n.n0,val:'n0',all:!0},{key:n.n2,val:'n2',all:!0},{key:n.c,val:'c',all:!0},{key:n.p0,val:'p0',all:!0},{key:n.p2,val:'p2',all:!0},{key:n.n2c,val:'n2,',all:!0},{key:n.n2cc,val:'n2,,',all:!0},{key:n.n2ccc,val:'n2,,,',all:!0},{key:n.d,val:'d',all:!1},{key:n.MMMMddyyyy,val:'MMMM dd, yyyy',all:!1},{key:n.dMyy,val:'d/M/yy',all:!1},{key:n.ddMyy,val:'dd/M/yy',all:!1},{key:n.ddMyyyy,val:'dd/M/yyyy',all:!1},{key:n.MMMyyyy,val:'MMM yyyy',all:!1},{key:n.MMMMyyyy,val:'MMMM yyyy',all:!1},{key:n.yyyy,val:'yyyy',all:!1},{key:n.yyyyQq,val:'yyyy "Q"q',all:!1},{key:n.FYEEEEQU,val:'"FY"EEEE "Q"U',all:!1}];this._cmbFmt.itemsSource=i;this._cmbFmt.isEditable=!0;this._cmbFmt.isRequired=!1;this._cmbFmt.collectionView.filter=function(n){return n&&n.all?!0:t._fld?t._fld.dataType==wjcCore.DataType.Date:!1};this._cmbFmt.initialize({displayMemberPath:'key',selectedValuePath:'val'})},t.prototype._initWeighByOptions=function(){var r=[{key:wjcCore.culture.olap.PivotFieldEditor.none,val:null}],i,t,n;if(this._fld)for(i=this._fld.engine,t=0;t<i.fields.length;t++)n=i.fields[t],n!=this._fld&&n.dataType==wjcCore.DataType.Number&&r.push({key:n.header,val:n});this._cmbWFl.initialize({displayMemberPath:'key',selectedValuePath:'val',itemsSource:r,selectedValue:this._fld.weightField})},t.prototype._initSortOptions=function(){var n=wjcCore.culture.olap.PivotFieldEditor.sorts,t=[{key:n.asc,val:!1},{key:n.desc,val:!0}];this._cmbSrt.itemsSource=t;this._cmbSrt.initialize({displayMemberPath:'key',selectedValuePath:'val'})},t.prototype._updateFormat=function(){switch(this._cmbShw.selectedValue){case ShowAs.DiffRowPct:case ShowAs.DiffColPct:this._cmbFmt.selectedValue='p0';break;default:this._cmbFmt.selectedValue='n0'}},t.prototype._updatePreview=function(){var n=this._cmbFmt.selectedValue||this._cmbFmt.text,i='',t,r;n&&(t=n[0].toLowerCase(),r='nfgxc',i=r.indexOf(t)>-1?wjcCore.Globalize.format(123.456,n):t=='p'?wjcCore.Globalize.format(.1234,n):wjcCore.Globalize.format(this._pvDate,n));this._cmbSmp.text=i},t.prototype._editFilter=function(){this._createFilterEditor();wjcCore.showPopup(this._dFlt,this._btnFltEdt,!1,!1,!1);wjcCore.moveFocus(this._dFlt,0)},t.prototype._createFilterEditor=function(){var n=this;this._dFlt||(this._dFlt=document.createElement('div'),this._eFlt=new PivotFilterEditor(this._dFlt,this._fld),wjcCore.addClass(this._dFlt,'wj-dropdown-panel'),this._eFlt.lostFocus.addHandler(function(){setTimeout(function(){var t=wjcCore.Control.getControl(n._dFlt);t&&!t.containsFocus()&&n._closeFilter()},10)}),this._eFlt.finishEditing.addHandler(function(){n._closeFilter();wjcCore.enable(n._btnFltClr,!0)}))},t.prototype._closeFilter=function(){this._dFlt&&(wjcCore.hidePopup(this._dFlt,!0),this.focus())},t}(wjcCore.Control);PivotFieldEditor.controlTemplate='<div><div class="wj-dialog-header" tabindex="-1"><span wj-part="g-dlg"><\/span> <span wj-part="sp-bnd"><\/span><\/div><div class="wj-dialog-body"><table style="table-layout:fixed"><tr><td wj-part="g-hdr"><\/td><td><div wj-part="div-hdr"><\/div><\/td><\/tr><tr class="wj-separator"><td wj-part="g-agg"><\/td><td><div wj-part="div-agg"><\/div><\/td><\/tr><tr class="wj-separator"><td wj-part="g-shw"><\/td><td><div wj-part="div-shw"><\/div><\/td><\/tr><tr><td wj-part="g-wfl"><\/td><td><div wj-part="div-wfl"><\/div><\/td><\/tr><tr><td wj-part="g-srt"><\/td><td><div wj-part="div-srt"><\/div><\/td><\/tr><tr class="wj-separator"><td wj-part="g-flt"><\/td><td><a wj-part="btn-flt-edt" href= "" draggable="false"><\/a>&nbsp;&nbsp;<a wj-part="btn-flt-clr" href= "" draggable="false"><\/a><\/td><\/tr><tr class="wj-separator"><td wj-part="g-fmt"><\/td><td><div wj-part="div-fmt"><\/div><\/td><\/tr><tr><td wj-part="g-smp"><\/td><td><div wj-part="div-smp" readonly disabled tabindex="-1"><\/div><\/td><\/tr><\/table><\/div><div class="wj-dialog-footer"><a class="wj-hide" wj-part="btn-apply" href="" draggable="false"><\/a>&nbsp;&nbsp;<a class="wj-hide" wj-part="btn-cancel" href="" draggable="false"><\/a><\/div><\/div>';exports.PivotFieldEditor=PivotFieldEditor;PivotFilterEditor=function(n){function t(t,i,r){var u=n.call(this,t)||this,e,o,f;return u.finishEditing=new wjcCore.Event,e='Missing dependency: PivotFilterEditor requires ',wjcCore.assert(wjcInput!=null,e+'wijmo.input.'),u.hostElement.tabIndex=-1,o=u.getTemplate(),u.applyTemplate('wj-control wj-pivotfiltereditor wj-content',o,{_divType:'div-type',_aVal:'a-val',_aCnd:'a-cnd',_divEdtVal:'div-edt-val',_divEdtCnd:'div-edt-cnd',_btnOk:'btn-ok'}),u._aVal.textContent=wjcCore.culture.FlexGridFilter.values,u._aCnd.textContent=wjcCore.culture.FlexGridFilter.conditions,u._btnOk.textContent=wjcCore.culture.olap.PivotFieldEditor.ok,f=u._btnClicked.bind(u),u.addEventListener(u._btnOk,'click',f),u.addEventListener(u._aVal,'click',f),u.addEventListener(u._aCnd,'click',f),u.addEventListener(u.hostElement,'keydown',function(n){switch(n.keyCode){case wjcCore.Key.Enter:switch(n.target.tagName){case'A':case'BUTTON':u._btnClicked(n);break;default:u.onFinishEditing(new wjcCore.CancelEventArgs)}n.preventDefault();break;case wjcCore.Key.Escape:u.onFinishEditing(new wjcCore.CancelEventArgs);n.preventDefault();break;case wjcCore.Key.Tab:wjcCore.moveFocus(u.hostElement,n.shiftKey?-1:1);n.preventDefault()}}),u._fld=i,u.initialize(r),u.updateEditor(),u}return __extends(t,n),Object.defineProperty(t.prototype,"field",{get:function(){return this._fld},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filter",{get:function(){return this._fld?this._fld.filter:null},enumerable:!0,configurable:!0}),t.prototype.updateEditor=function(){var n=wjcGridFilter.FilterType.None;this.filter&&(n=this.filter.conditionFilter.isActive||(this.filter.filterType&wjcGridFilter.FilterType.Value)==0?wjcGridFilter.FilterType.Condition:wjcGridFilter.FilterType.Value,this._showFilter(n));this._edtVal&&this._edtVal.updateEditor();this._edtCnd&&this._edtCnd.updateEditor()},t.prototype.updateFilter=function(){switch(this._getFilterType()){case wjcGridFilter.FilterType.Value:this._edtVal.updateFilter();this.filter.conditionFilter.clear();break;case wjcGridFilter.FilterType.Condition:this._edtCnd.updateFilter();this.filter.valueFilter.clear()}this.field.onPropertyChanged(new wjcCore.PropertyChangedEventArgs('filter',null,null))},t.prototype.clearEditor=function(){this._edtVal&&this._edtVal.clearEditor();this._edtCnd&&this._edtCnd.clearEditor()},t.prototype.onFinishEditing=function(n){return this.finishEditing.raise(this,n),!n.cancel},t.prototype._showFilter=function(n){n==wjcGridFilter.FilterType.Value&&this._edtVal==null&&(this._edtVal=new wjcGridFilter.ValueFilterEditor(this._divEdtVal,this.filter.valueFilter));n==wjcGridFilter.FilterType.Condition&&this._edtCnd==null&&(this._edtCnd=new wjcGridFilter.ConditionFilterEditor(this._divEdtCnd,this.filter.conditionFilter));(n&this.filter.filterType)!=0&&(n==wjcGridFilter.FilterType.Value?(this._divEdtVal.style.display='',this._divEdtCnd.style.display='none',this._enableLink(this._aVal,!1),this._enableLink(this._aCnd,!0)):(this._divEdtVal.style.display='none',this._divEdtCnd.style.display='',this._enableLink(this._aVal,!0),this._enableLink(this._aCnd,!1)));switch(this.filter.filterType){case wjcGridFilter.FilterType.None:case wjcGridFilter.FilterType.Condition:case wjcGridFilter.FilterType.Value:this._divType.style.display='none';break;default:this._divType.style.display=''}},t.prototype._enableLink=function(n,t){n.style.textDecoration=t?'':'none';n.style.fontWeight=t?'':'bold';wjcCore.setAttribute(n,'href',t?'':null)},t.prototype._getFilterType=function(){return this._divEdtVal.style.display!='none'?wjcGridFilter.FilterType.Value:wjcGridFilter.FilterType.Condition},t.prototype._btnClicked=function(n){if(n.preventDefault(),n.stopPropagation(),!wjcCore.hasClass(n.target,'wj-state-disabled')){if(n.target==this._aVal){this._showFilter(wjcGridFilter.FilterType.Value);wjcCore.moveFocus(this._edtVal.hostElement,0);return}if(n.target==this._aCnd){this._showFilter(wjcGridFilter.FilterType.Condition);wjcCore.moveFocus(this._edtCnd.hostElement,0);return}this.onFinishEditing(new wjcCore.CancelEventArgs)}},t}(wjcCore.Control);PivotFilterEditor.controlTemplate='<div><div wj-part="div-type" style="text-align:center;margin-bottom:12px;font-size:80%"><a wj-part="a-cnd" href="" tabindex="-1" draggable="false"><\/a>&nbsp;|&nbsp;<a wj-part="a-val" href="" tabindex="-1" draggable="false"><\/a><\/div><div wj-part="div-edt-val"><\/div><div wj-part="div-edt-cnd"><\/div><div style="text-align:right;margin-top:10px"><a wj-part="btn-ok" href="" tabindex="-1" draggable="false"><\/a><\/div>';exports.PivotFilterEditor=PivotFilterEditor;wjcCore.culture.olap=wjcCore.culture.olap||{};wjcCore.culture.olap.PivotEngine=window.wijmo.culture.olap.PivotEngine||{grandTotal:'Grand Total',subTotal:'Subtotal'},function(n){n[n.None=0]="None";n[n.GrandTotals=1]="GrandTotals";n[n.Subtotals=2]="Subtotals"}(ShowTotals=exports.ShowTotals||(exports.ShowTotals={})),function(n){n[n.NoCalculation=0]="NoCalculation";n[n.DiffRow=1]="DiffRow";n[n.DiffRowPct=2]="DiffRowPct";n[n.DiffCol=3]="DiffCol";n[n.DiffColPct=4]="DiffColPct";n[n.PctGrand=5]="PctGrand";n[n.PctRow=6]="PctRow";n[n.PctCol=7]="PctCol";n[n.RunTot=8]="RunTot";n[n.RunTotPct=9]="RunTotPct"}(ShowAs=exports.ShowAs||(exports.ShowAs={}));PivotEngine=function(){function n(n){var i,t;for(this._autoGenFields=!0,this._allowFieldEditing=!0,this._showRowTotals=ShowTotals.GrandTotals,this._showColTotals=ShowTotals.GrandTotals,this._updating=0,this._cntTotal=0,this._cntFiltered=0,this._async=!0,this._serverParms={timeout:_ServerConnection._TIMEOUT,pollInterval:_ServerConnection._POLL_INTERVAL,maxDetail:_ServerConnection._MAXDETAIL},this.itemsSourceChanged=new wjcCore.Event,this.viewDefinitionChanged=new wjcCore.Event,this.updatingView=new wjcCore.Event,this.updatedView=new wjcCore.Event,this.error=new wjcCore.Event,this._pivotView=new PivotCollectionView(this),this._fields=new PivotFieldCollection(this),this._rowFields=new PivotFieldCollection(this),this._columnFields=new PivotFieldCollection(this),this._valueFields=new PivotFieldCollection(this),this._filterFields=new PivotFieldCollection(this),this._viewLists=[this._rowFields,this._columnFields,this._valueFields,this._filterFields],i=this._fieldListChanged.bind(this),this._fields.collectionChanged.addHandler(i),t=0;t<this._viewLists.length;t++)this._viewLists[t].collectionChanged.addHandler(i);this._defaultFilterType=null;n&&wjcCore.copy(this,n)}return Object.defineProperty(n.prototype,"itemsSource",{get:function(){return this._items},set:function(n){var t=this;this._items!=n&&(this._cv&&(this._cv.collectionChanged.removeHandler(this._cvCollectionChanged,this),this._cv=null),this._server&&(this._server.clearPendingRequests(),this._server=null),this._items=n,wjcCore.isString(n)?this._server=new _ServerConnection(this,n):this._cv=wjcCore.asCollectionView(n),this._cv!=null&&this._cv.collectionChanged.addHandler(this._cvCollectionChanged,this),this.deferUpdate(function(){t.autoGenerateFields&&t._generateFields()}),this.onItemsSourceChanged())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"collectionView",{get:function(){return this._cv},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pivotView",{get:function(){return this._pivotView},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"showRowTotals",{get:function(){return this._showRowTotals},set:function(n){n!=this.showRowTotals&&(this._showRowTotals=wjcCore.asEnum(n,ShowTotals),this.onViewDefinitionChanged(),this.invalidate())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"showColumnTotals",{get:function(){return this._showColTotals},set:function(n){n!=this.showColumnTotals&&(this._showColTotals=wjcCore.asEnum(n,ShowTotals),this.onViewDefinitionChanged(),this.invalidate())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"totalsBeforeData",{get:function(){return this._totalsBefore},set:function(n){n!=this._totalsBefore&&(this._totalsBefore=wjcCore.asBoolean(n),this.onViewDefinitionChanged(),this._updatePivotView())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"showZeros",{get:function(){return this._showZeros},set:function(n){n!=this._showZeros&&(this._showZeros=wjcCore.asBoolean(n),this.onViewDefinitionChanged(),this._updatePivotView())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"defaultFilterType",{get:function(){return this._defaultFilterType!=null?this._defaultFilterType:this._server?wjcGridFilter.FilterType.Condition:wjcGridFilter.FilterType.Both},set:function(n){this._defaultFilterType=wjcCore.asEnum(n,wjcGridFilter.FilterType)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"autoGenerateFields",{get:function(){return this._autoGenFields},set:function(n){this._autoGenFields=wjcCore.asBoolean(n)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"allowFieldEditing",{get:function(){return this._allowFieldEditing},set:function(n){this._allowFieldEditing=wjcCore.asBoolean(n)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fields",{get:function(){return this._fields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rowFields",{get:function(){return this._rowFields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"columnFields",{get:function(){return this._columnFields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"filterFields",{get:function(){return this._filterFields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"valueFields",{get:function(){return this._valueFields},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"viewDefinition",{get:function(){for(var n,t,r={showZeros:this.showZeros,showColumnTotals:this.showColumnTotals,showRowTotals:this.showRowTotals,defaultFilterType:this.defaultFilterType,totalsBeforeData:this.totalsBeforeData,fields:[],rowFields:this._getFieldCollectionProxy(this.rowFields),columnFields:this._getFieldCollectionProxy(this.columnFields),filterFields:this._getFieldCollectionProxy(this.filterFields),valueFields:this._getFieldCollectionProxy(this.valueFields)},i=0;i<this.fields.length;i++)n=this.fields[i],t={binding:n.binding,header:n.header,dataType:n.dataType,aggregate:n.aggregate,showAs:n.showAs,descending:n.descending,format:n.format,width:n.width,isContentHtml:n.isContentHtml},n.weightField&&(t.weightField=n.weightField._getName()),n.key&&(t.key=n.key),n.filter.isActive&&(t.filter=this._getFilterProxy(n)),r.fields.push(t);return JSON.stringify(r)},set:function(t){var i=this,r=JSON.parse(t);r&&this.deferUpdate(function(){var f,t,u;for(i._copyProps(i,r,n._props),i.fields.clear(),t=0;t<r.fields.length;t++)u=r.fields[t],f=new PivotField(i,u.binding,u.header),f._autoGenerated=!0,i._copyProps(f,u,PivotField._props),u.filter&&i._setFilterProxy(f,u.filter),i.fields.push(f);for(t=0;t<r.fields.length;t++)u=r.fields[t],wjcCore.isString(u.weightField)&&(i.fields[t].weightField=i.fields.getField(u.weightField));i._setFieldCollectionProxy(i.rowFields,r.rowFields);i._setFieldCollectionProxy(i.columnFields,r.columnFields);i._setFieldCollectionProxy(i.filterFields,r.filterFields);i._setFieldCollectionProxy(i.valueFields,r.valueFields)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isViewDefined",{get:function(){return this._valueFields.length>0&&(this._rowFields.length>0||this._columnFields.length>0)},enumerable:!0,configurable:!0}),n.prototype.beginUpdate=function(){this.cancelPendingUpdates();this._updating++},n.prototype.endUpdate=function(){this._updating--;this._updating<=0&&(this.onViewDefinitionChanged(),this.refresh())},Object.defineProperty(n.prototype,"isUpdating",{get:function(){return this._updating>0},enumerable:!0,configurable:!0}),n.prototype.deferUpdate=function(n){try{this.beginUpdate();n()}finally{this.endUpdate()}},n.prototype.refresh=function(n){n===void 0&&(n=!1);(!this.isUpdating||n)&&this._updateView()},n.prototype.invalidate=function(){var n=this;this._toInv&&(this._toInv=clearTimeout(this._toInv));this.isUpdating||(this._toInv=setTimeout(function(){n.refresh()},10))},Object.defineProperty(n.prototype,"async",{get:function(){return this._async},set:function(n){n!=this._async&&(this.cancelPendingUpdates(),this._async=wjcCore.asBoolean(n))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"serverTimeout",{get:function(){return this._serverParms.timeout},set:function(n){this._serverParms.timeout=wjcCore.asNumber(n,!1,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"serverPollInterval",{get:function(){return this._serverParms.pollInterval},set:function(n){this._serverParms.pollInterval=wjcCore.asNumber(n,!1,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"serverMaxDetail",{get:function(){return this._serverParms.maxDetail},set:function(n){this._serverParms.maxDetail=wjcCore.asNumber(n,!1,!0)},enumerable:!0,configurable:!0}),n.prototype.cancelPendingUpdates=function(){this._toUpdateTallies&&(clearTimeout(this._toUpdateTallies),this._toUpdateTallies=null)},n.prototype.getDetail=function(n,t){var u=n?n[_PivotKey._ROW_KEY_NAME]:null,f=this._getKey(t),e,o,r,i;if(this._server)return this._server.getDetail(u,f);for(e=this.collectionView.items,o=[],r=0;r<e.length;r++)i=e[r],this._applyFilter(i)&&(u==null||u.matchesItem(i))&&(f==null||f.matchesItem(i))&&o.push(i);return o},n.prototype.getDetailView=function(n,t){var i=this.getDetail(n,t);return new wjcCore.CollectionView(i)},n.prototype.getKeys=function(n,t){var i=n?n[_PivotKey._ROW_KEY_NAME]:null,r=this._getKey(t);return{rowKey:{fields:i.fieldNames,values:i.values},colKey:{fields:r.fieldNames,values:r.values}}},n.prototype.editField=function(n){if(this.allowFieldEditing){var t=new PivotFieldEditor(document.createElement('div'),{field:n}),i=new wjcInput.Popup(document.createElement('div'),{content:t.hostElement});i.show(!0)}},n.prototype.removeField=function(n){for(var i,r,t=0;t<this._viewLists.length;t++)if(i=this._viewLists[t],r=i.indexOf(n),r>-1){i.removeAt(r);return}},n.prototype.onItemsSourceChanged=function(n){this.itemsSourceChanged.raise(this,n)},n.prototype.onViewDefinitionChanged=function(n){this._updating||this.viewDefinitionChanged.raise(this,n)},n.prototype.onUpdatingView=function(n){this.updatingView.raise(this,n)},n.prototype.onUpdatedView=function(n){this.updatedView.raise(this,n)},n.prototype.onError=function(n){return this.error.raise(this,n),!n.cancel},n.prototype._copy=function(n,t){var r,i,u;switch(n){case'fields':for(this.fields.clear(),i=0;i<this._viewLists.length;i++)this._viewLists[i].clear();for(r=wjcCore.asArray(t),i=0;i<r.length;i++)u=this._createField(r[i],!1),this.fields.push(u);return!0;case'rowFields':case'columnFields':case'valueFields':case'filterFields':for(this[n].clear(),wjcCore.isArray(t)||(this[n].maxItems=t.maxItems,t=t.items),r=wjcCore.asArray(t),i=0;i<r.length;i++)u=this.fields.getField(r[i]),this[n].push(u);return!0}return!1},n.prototype._getKey=function(n){return this._keys[n]},n.prototype._getRowLevel=function(n){if(wjcCore.isNumber(n)){var t=this._pivotView.items[n];n=t?t[_PivotKey._ROW_KEY_NAME]:null}return!n||n._fieldCount==this.rowFields.length?-1:n._fieldCount},n.prototype._getColLevel=function(n){return wjcCore.isNumber(n)&&(n=this._colBindings[n]),wjcCore.isString(n)&&(n=this._getKey(n)),wjcCore.assert(n==null||n instanceof _PivotKey,'invalid parameter in call to _getColLevel'),!n||n._fieldCount==this.columnFields.length?-1:n._fieldCount},n.prototype._applyFilter=function(n){for(var r,i=this._activeFilterFields,t=0;t<i.length;t++)if(r=i[t].filter,!r.apply(n))return!1;return!0},n.prototype._updateView=function(){var i=this,r,n,u,t,f;if(this.cancelPendingUpdates(),this._cntTotal=this._cntFiltered=0,this._tallies={},this._keys={},this._activeFilterFields=[],this._server&&this.isViewDefined){this._server.getOutputView(function(n){i.isViewDefined&&(i._server.updateTallies(n),i._updatePivotView())});return}for(r=this._viewLists,n=0;n<r.length;n++)for(u=r[n],t=0;t<u.length;t++)f=u[t],f.filter.isActive&&this._activeFilterFields.push(f);this.isViewDefined&&this._cv&&this._cv.items?(this._batchStart=Date.now(),this._updateTallies(this._cv.items,0)):this._updatePivotView()},n.prototype._updateTallies=function(t,i){for(var s,u=this,h=t.length,c=new _PivotNode(this._rowFields,0,null,-1,null),f=this._rowFields.length,l=this._showRowTotals==ShowTotals.None?f:0,a=this._showRowTotals==ShowTotals.GrandTotals?Math.max(1,f):1,e=this._columnFields.length,v=this._showColTotals==ShowTotals.None?e:0,y=this._showColTotals==ShowTotals.GrandTotals?Math.max(1,e):1,p=this._valueFields.length,w=function(o){var s,w,k,h;if(r._async&&o-i>=n._BATCH_SIZE&&Date.now()-r._batchStart>n._BATCH_DELAY)return r._toUpdateTallies=setTimeout(function(){u.onUpdatingView(new ProgressEventArgs(Math.round(o/t.length*100)));u._batchStart=Date.now();u._updateTallies(t,o)},n._BATCH_TIMEOUT),{value:void 0};if(r._cntTotal++,s=t[o],!r._activeFilterFields.length||r._applyFilter(s))for(r._cntFiltered++,w=l;w<=f;w+=a){var it=c.getNode(r._rowFields,w,null,-1,s),rt=it.key,d=rt.toString(),b=r._tallies[d];for(b||(r._keys[d]=rt,r._tallies[d]=b={}),k=v;k<=e;k+=y)for(h=0;h<p;h++){var ft=it.tree.getNode(r._columnFields,k,r._valueFields,h,s),ut=ft.key,g=ut.toString(),nt=b[g];nt||(r._keys[g]=ut,nt=b[g]=new _Tally);var tt=r._valueFields[h],et=tt._getValue(s,!1),ot=tt._weightField?tt._getWeight(s):null;nt.add(et,ot)}}},r=this,o=i;o<h;o++)if(s=w(o),typeof s=="object")return s.value;this._toUpdateTallies=null;this._updatePivotView()},n.prototype._updatePivotView=function(){var n=this;this._pivotView.deferUpdate(function(){var t,e,o,i,s,v,h,r,u,f;n.onUpdatingView(new ProgressEventArgs(100));t=n._pivotView.sourceCollection;t.length=0;e={};for(i in n._tallies)e[i]=!0;o={};for(i in n._tallies){s=n._tallies[i];for(v in s)o[v]=!0}for(h=n._getSortedKeys(e),r=n._getSortedKeys(o),u=0;u<h.length;u++){var y=h[u],s=n._tallies[y],c={};for(c[_PivotKey._ROW_KEY_NAME]=n._getKey(y),f=0;f<r.length;f++){var l=r[f],p=s[l],w=n._getKey(l),a=p?p.getAggregate(w.aggregate):null;a!=0||n._showZeros||(a=null);c[l]=a}t.push(c)}n._colBindings=r;n._updateFieldValues(t);n._pivotView.sortDescriptions.clear();n.onUpdatedView()})},n.prototype._getSortedKeys=function(n){var t=this;return Object.keys(n).sort(function(n,i){return t._keys[n].compareTo(t._keys[i])})},n.prototype._updateFieldValues=function(n){for(var s,l,h,c,o,i,t,u,r,e=this.valueFields.length,f=0;f<e;f++){s=this.valueFields[f];switch(s.showAs){case ShowAs.RunTot:case ShowAs.RunTotPct:for(t=f;t<this._colBindings.length;t+=e){for(i=0;i<n.length;i++)u=n[i],r=this._colBindings[t],u[r]=this._getRunningTotal(n,i,t,s.showAs);if(s.showAs==ShowAs.RunTotPct)for(i=0;i<n.length;i++){var u=n[i],r=this._colBindings[t],a=u[r];wjcCore.isNumber(a)&&(l=this._getLastValueInRowGroup(n,i,t),l!=0&&(u[r]=a/l))}}break;case ShowAs.PctGrand:case ShowAs.PctCol:if(h=0,s.showAs==ShowAs.PctGrand)for(t=f;t<this._colBindings.length;t+=e)this._getColLevel(t)==-1&&(h+=this._getColTotal(n,t));for(t=f;t<this._colBindings.length;t+=e)for(s.showAs==ShowAs.PctCol&&(h=this._getColTotal(n,t)),r=this._colBindings[t],i=0;i<n.length;i++)u=n[i],o=u[r],wjcCore.isNumber(o)&&(u[r]=h!=0?o/h:null);break;case ShowAs.PctRow:for(i=0;i<n.length;i++){for(u=n[i],c=0,t=f;t<this._colBindings.length;t+=e)this._getColLevel(t)==-1&&(r=this._colBindings[t],o=u[r],wjcCore.isNumber(o)&&(c+=o));for(t=f;t<this._colBindings.length;t+=e)r=this._colBindings[t],o=u[r],wjcCore.isNumber(o)&&(u[r]=c!=0?o/c:null)}break;case ShowAs.DiffRow:case ShowAs.DiffRowPct:for(t=f;t<this._colBindings.length;t+=e)for(i=n.length-1;i>=0;i--)u=n[i],r=this._colBindings[t],u[r]=this._getRowDifference(n,i,t,s.showAs);break;case ShowAs.DiffCol:case ShowAs.DiffColPct:for(i=0;i<n.length;i++)for(t=this._colBindings.length-e+f;t>=0;t-=e)u=n[i],r=this._colBindings[t],u[r]=this._getColDifference(n,i,t,s.showAs)}}},n.prototype._getColTotal=function(n,t){for(var r,f=this._colBindings[t],u=0,i=0;i<n.length;i++)this._getRowLevel(i)==-1&&(r=n[i][f],wjcCore.isNumber(r)&&(u+=r));return u},n.prototype._getRunningTotal=function(n,t,i){var u=this._getRowLevel(t),r,e,h,c,l;if(u==0)return null;var o=this._colBindings[i],s=n[t][o],f=this.rowFields.length-2;for(r=t-1;r>=0;r--){if(e=this._getRowLevel(r),e==u){if(f>-1&&u<0&&this._showRowTotals!=ShowTotals.Subtotals&&(h=n[t].$rowKey,c=n[r].$rowKey,h.values[f]!=c.values[f]))return null;l=n[r][o];s+=l;break}if(e>u)break}return s},n.prototype._getLastValueInRowGroup=function(n,t,i){for(var o,h,c,s=this._colBindings[i],u=n[t][s],f=this._getRowLevel(t),e=this.rowFields.length-2,r=t+1;r<n.length;r++){if(o=this._getRowLevel(r),o==f){if(e>-1&&f<0&&this._showRowTotals!=ShowTotals.Subtotals&&(h=n[t].$rowKey,c=n[r].$rowKey,h.values[e]!=c.values[e]))return u;u=n[r][s]}if(o>f)break}return u},n.prototype._getRowDifference=function(n,t,i,r){var f=this._getRowLevel(t),e,u,o,s,h;if(f==0)return null;for(e=this.rowFields.length-2,u=t-1;u>=0;u--){if(o=this._getRowLevel(u),o==f){if(e>-1&&f<0&&this._showRowTotals!=ShowTotals.Subtotals&&(s=n[t].$rowKey,h=n[u].$rowKey,s.values[e]!=h.values[e]))return null;var c=this._colBindings[i],v=n[t][c],l=n[u][c],a=v-l;return r==ShowAs.DiffRowPct&&(a/=l),a}if(o>f)break}return null},n.prototype._getColDifference=function(n,t,i,r){var f=this._getColLevel(i),o,e,u,s,h,c;if(f==0)return null;for(o=this.valueFields.length,e=this.columnFields.length-2,u=i-o;u>=0;u-=o){if(s=this._getColLevel(u),s==f){if(e>-1&&f<0&&this._showColTotals!=ShowTotals.Subtotals&&(h=this._getKey(this._colBindings[i]),c=this._getKey(this._colBindings[u]),h.values[e]!=c.values[e]))return null;var l=n[t],y=l[this._colBindings[i]],a=l[this._colBindings[u]],v=y-a;return r==ShowAs.DiffColPct&&(v/=a),v}if(s>f)break}return null},n.prototype._generateFields=function(){for(var o,i,s,f,e,r,u,t,n=0;n<this._viewLists.length;n++)this._viewLists[n].clear();for(n=0;n<this.fields.length;n++)t=this.fields[n],t._autoGenerated&&(this.fields.removeAt(n),n--);if(this._server){for(o=this._server.getFields(),n=0;n<o.length;n++)t=this._createField(o[n],!0),this.fields.push(t);return}if(i=null,s=this.collectionView,wjcCore.hasItems(s)&&(f=s.sourceCollection,i=f[0]),i&&this.autoGenerateFields)for(e in i)for(r=null,u=0;u<f.length&&u<1e3&&r==null;u++)r=f[u][e],wjcCore.isPrimitive(r)&&(t=this._createField({binding:e,header:wjcCore.toHeaderCase(e),dataType:wjcCore.getType(r)},!0),this.fields.push(t));if(i)for(n=0;n<this.fields.length;n++)t=this.fields[n],t.dataType==null&&t._binding&&(t.dataType=wjcCore.getType(t._binding.getValue(i)))},n.prototype._createField=function(n,t){var i;if(i=wjcCore.isString(n)?new PivotField(this,n):n.dimensionType!=null?new CubePivotField(this,n.binding,n.header,n):new PivotField(this,n.binding,n.header,n),i._autoGenerated=t,t||wjcCore.isString(n))switch(i.dataType){case wjcCore.DataType.Number:i.aggregate=wjcCore.Aggregate.Sum;i.format='n0';break;case wjcCore.DataType.Date:i.aggregate=wjcCore.Aggregate.Cnt;i.format='d';break;default:i.aggregate=wjcCore.Aggregate.Cnt}return i},n.prototype._cvCollectionChanged=function(){this.invalidate()},n.prototype._fieldListChanged=function(n,t){var i,f,r,e,u;if(t.action==wjcCore.NotifyCollectionChangedAction.Add){for(i=n,r=0;r<i.length-1;r++)if(i[r].key)for(f=r+1;f<i.length;f++)i[r].key==i[f].key&&(i.removeAt(f),f--);if(i!=this._fields)if(this._fields.getField(t.item.key))for(r=0;r<this._viewLists.length;r++)this._viewLists[r]!=i&&(e=this._viewLists[r],u=e.indexOf(t.item),u>-1&&e.removeAt(u));else i.removeAt(t.index);if(wjcCore.isNumber(i.maxItems)&&i.maxItems>-1)while(i.length>i.maxItems)u=i.length-1,i[u]==t.item&&u>0&&u--,i.removeAt(u)}this.onViewDefinitionChanged();this.invalidate()},n.prototype._fieldPropertyChanged=function(n,t){if(this.onViewDefinitionChanged(),n.isActive){var i=t.propertyName;if(i=='width'||i=='wordWrap'||i=='isContentHtml'){this._pivotView.refresh();return}if(i=='format'&&this.valueFields.indexOf(n)>-1){this._pivotView.refresh();return}if(i=='showAs'){this.valueFields.indexOf(n)>-1&&!this.isUpdating&&this._updatePivotView();return}if(i=='descending'){this._updatePivotView();return}if(i=='aggregate'){this.valueFields.indexOf(n)>-1&&!this.isUpdating&&(this._server?this._updateView():this._updatePivotView());return}this.invalidate()}},n.prototype._copyProps=function(n,t,i){for(var u,r=0;r<i.length;r++)u=i[r],t[u]!=null&&(n[u]=t[u])},n.prototype._getFieldCollectionProxy=function(n){var i={items:[]},t,r;for(wjcCore.isNumber(n.maxItems)&&n.maxItems>-1&&(i.maxItems=n.maxItems),t=0;t<n.length;t++)r=n[t],i.items.push(r.key);return i},n.prototype._setFieldCollectionProxy=function(n,t){n.clear();n.maxItems=wjcCore.isNumber(t.maxItems)?t.maxItems:null;for(var i=0;i<t.items.length;i++)n.push(t.items[i])},n.prototype._getFilterProxy=function(n){var i=n.filter,t,r,u;return i.conditionFilter.isActive?(t=i.conditionFilter,r={type:'condition',condition1:{operator:t.condition1.operator,value:t.condition1.value},and:t.and,condition2:{operator:t.condition2.operator,value:t.condition2.value}},t.condition1.isActive||delete r.condition1,t.condition2.isActive||delete r.condition2,r):i.valueFilter.isActive?(u=i.valueFilter,{type:'value',filterText:u.filterText,showValues:u.showValues}):(wjcCore.assert(!1,'inactive filters shouldn\'t be persisted.'),null)},n.prototype._setFilterProxy=function(n,t){var u=n.filter,i,r,f;u.clear();switch(t.type){case'condition':i=u.conditionFilter;t.condition1&&(r=wjcCore.changeType(t.condition1.value,n.dataType,n.format),i.condition1.value=r?r:t.condition1.value,i.condition1.operator=t.condition1.operator);wjcCore.isBoolean(t.and)&&(i.and=t.and);t.condition2&&(r=wjcCore.changeType(t.condition2.value,n.dataType,n.format),i.condition2.value=r?r:t.condition2.value,i.condition2.operator=t.condition2.operator);break;case'value':f=u.valueFilter;f.filterText=t.filterText;f.showValues=t.showValues}},n}();PivotEngine._BATCH_SIZE=1e4;PivotEngine._BATCH_TIMEOUT=0;PivotEngine._BATCH_DELAY=100;PivotEngine._props=['showZeros','showRowTotals','showColumnTotals','totalsBeforeData','defaultFilterType'];exports.PivotEngine=PivotEngine;ProgressEventArgs=function(n){function t(t){var i=n.call(this)||this;return i._progress=wjcCore.asNumber(t),i}return __extends(t,n),Object.defineProperty(t.prototype,"progress",{get:function(){return this._progress},enumerable:!0,configurable:!0}),t}(wjcCore.EventArgs);exports.ProgressEventArgs=ProgressEventArgs;_ServerConnection=function(){function n(n,t){this._ng=wjcCore.asType(n,PivotEngine);wjcCore.assert(this._isValidUrl(t),'Invalid service Url: '+t+')')}return n.prototype.getFields=function(){var t=this,n=null;return wjcCore.httpRequest(this._getUrl('Fields'),{async:!1,success:function(t){n=JSON.parse(t.responseText);wjcCore.isArray(n)||console.error('Failed to get fields from server: '+t.responseText)},error:function(n){t._handleError('Getting Fields',n)}}),n},n.prototype.getOutputView=function(n){var t=this;this.clearPendingRequests();this._sendHttpRequest('Analyses',{method:'POST',data:{view:this._ng.viewDefinition},success:function(i){var r=JSON.parse(i.responseText);t._token=r.token;t._start=Date.now();t._handleResult(r.status,n)},error:function(n){t._handleError('Analyses',n)}})},n.prototype.getDetail=function(t,i){for(var f,u=[],e=this._ng.rowFields.length,o=t?t.values.length:0,r=0;r<e;r++)r<o?u.push(n._getRequestedValue(t.values[r])):u.push(null);for(e=this._ng.columnFields.length,o=i?i.values.length:0,r=0;r<e;r++)r<o?u.push(n._getRequestedValue(i.values[r])):u.push(null);return f=new wjcCore.ObservableArray,this._loadArray('Detail',f,{method:'POST',view:this._ng.viewDefinition,keys:u,max:this._ng.serverMaxDetail}),f},n._getRequestedValue=function(n){if(wjcCore.isDate(n)){var t=n;return new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()))}return n},n.prototype.clearPendingRequests=function(){this._clearRequest();this._clearTimeout();this._clearToken()},n.prototype.updateTallies=function(n){var i=this,t=this._ng,r=t.rowFields.length,u=t.columnFields.length,f=t.valueFields.length,e=new _PivotNode(t.rowFields,0,null,-1,null);n.forEach(function(n){var h=i._getAggregatedFieldCount(n,t.rowFields),v=e.getNode(t.rowFields,r-h,null,-1,n),y=v.key,c=y.toString(),s=t._tallies[c],o;for(s||(t._keys[c]=y,t._tallies[c]=s={}),h=i._getAggregatedFieldCount(n,t.columnFields),o=0;o<f;o++){var w=v.tree.getNode(t.columnFields,u-h,t.valueFields,o,n),p=w.key,l=p.toString(),b=t.valueFields[o],a=s[l];a?wjcCore.assert(!1,'Server tallies have a single value.'):(t._keys[l]=p,a=s[l]=new _ServerTally,a.add(i._getFieldValue(b,n,!1)))}})},n.prototype._getFieldValue=function(n,t,i){var r=t[n.key];return!i||typeof r=='string'?r:wjcCore.Globalize.format(r,n.format)},n.prototype._getAggregatedFieldCount=function(n,t){for(var u,f=t.length,r=0,i=0;i<f;i++)u=t[i],this._getFieldValue(u,n,!1)==null&&r++;return r},n.prototype._loadArray=function(n,t,i){var r=this,u;i||(i={});i.skip==null&&(i.skip=0);i.top==null&&(i.top=100);u=wjcCore.isNumber(i.max)?i.max:1e6;wjcCore.httpRequest(this._getUrl(n),{data:i,method:i.method||'GET',success:function(f){var e=JSON.parse(f.responseText);t.deferUpdate(function(){e.value.forEach(function(n){t.push(n)})});e.value.length==i.top&&t.length<u&&(i.skip+=i.top,r._loadArray(n,t,i))},error:function(t){r._handleError(n,t)}})},n.prototype._getUrl=function(n,t,i){t===void 0&&(t=this._token);var r=this._ng.itemsSource.toString(),u=r.lastIndexOf('/'),f=r.substr(0,u);n=n.toLowerCase();switch(n){case'rawdata':case'detail':return r;case'fields':case'analyses':return r+'/'+n;case'clear':return r+'/analyses/'+t+'/';case'result':case'status':return r+'/analyses/'+t+'/'+n;case'uniquevalues':return r+'/fields/'+i+'/'+n}wjcCore.assert(!1,'Unrecognized command')},n.prototype._isValidUrl=function(n){var t=document.createElement('a');return t.href=wjcCore.asString(n),t.href=t.href,t.protocol&&t.hostname&&t.pathname&&n[n.length-1]!='/'},n.prototype._handleResult=function(n,t){var i=this;switch(n.executingStatus.toLowerCase()){case'executing':case'notset':if(Date.now()-this._start>this._ng.serverTimeout){this._handleError('Analyses',{status:500,statusText:'Analysis timed out'});return}this._progress=n.progress;this._ng.onUpdatingView(new ProgressEventArgs(this._progress));this._clearTimeout();this._toGetStatus=setTimeout(function(){i._waitUntilComplete(t)},this._ng.serverPollInterval);break;case'completed':this._progress=100;this._ng.onUpdatingView(new ProgressEventArgs(this._progress));this._getResults(t);break;case'exception':this._getResults(t);break;default:this._handleError('Analyses',{status:500,statusText:'Unexpected result...'})}},n.prototype._waitUntilComplete=function(n){var t=this;this._sendHttpRequest('Status',{success:function(i){var r=JSON.parse(i.responseText);t._handleResult(r,n)},error:function(n){t._handleError('Status',n)}})},n.prototype._getResults=function(n){var t=this;this._sendHttpRequest('Result',{success:function(i){var u,r;t._clearToken();u=JSON.parse(i.responseText);wjcCore.assert(wjcCore.isArray(u),'Result array Expected.');r=[];t._ng._viewLists.forEach(function(n){r=r.concat(n.filter(function(n){return n.dataType==wjcCore.DataType.Date}))});r.length>0&&u.forEach(function(n){r.forEach(function(t){var i=t._binding,r=i.getValue(n);wjcCore.isString(r)&&i.setValue(n,new Date(r))})});wjcCore.asFunction(n)(u)},error:function(n){t._handleError('Result',n)}})},n.prototype._handleError=function(n,t){this.clearPendingRequests();n='** HttpRequest error on command "'+n+'"';this._ng.onError(new wjcCore.RequestErrorEventArgs(t,n))&&this._throwResponseError(n,t)},n.prototype._throwResponseError=function(n,t){var i,r;n=n+'\r\n'+t.status+'\r\n';i=t.responseText||'';t.status==500&&t.responseText&&(r=JSON.parse(t.responseText),i=r.ExceptionMessage);n+=i||t.statusText;throw n;},n.prototype._sendHttpRequest=function(n,t){var i=this._getUrl(n);this._request=wjcCore.httpRequest(i,t)},n.prototype._clearToken=function(){this._token&&(this._clearRequest(),this._clearTimeout(),this._sendHttpRequest('Clear',{method:'DELETE'}),this._token=null)},n.prototype._clearRequest=function(){this._request&&this._request.readyState!=4&&(this._request.abort(),this._request=null)},n.prototype._clearTimeout=function(){this._toGetStatus&&(clearTimeout(this._toGetStatus),this._toGetStatus=null)},n}();_ServerConnection._TIMEOUT=6e4;_ServerConnection._POLL_INTERVAL=500;_ServerConnection._MAXDETAIL=1e3;exports._ServerConnection=_ServerConnection;_ServerTally=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.add=function(n){wjcCore.assert(this._cnt==0,'Server tallies have a single value.');this._aggregatedValue=n},t.prototype.getAggregate=function(){return this._aggregatedValue},t}(_Tally);wjcCore.culture.olap=wjcCore.culture.olap||{};wjcCore.culture.olap._ListContextMenu=window.wijmo.culture.olap._ListContextMenu||{up:'Move Up',down:'Move Down',first:'Move to Beginning',last:'Move to End',filter:'Move to Report Filter',rows:'Move to Row Labels',cols:'Move to Column Labels',vals:'Move to Values',remove:'Remove Field',edit:'Field Settings...',detail:'Show Detail...'};_ListContextMenu=function(n){function t(t){var i=n.call(this,document.createElement('div'),{header:'Field Context Menu',displayMemberPath:'text',commandParameterPath:'parm',command:{executeCommand:function(n){i._execute(n)},canExecuteCommand:function(n){return i._canExecute(n)}}})||this;return i._full=t,i.itemsSource=i._getMenuItems(t),wjcCore.addClass(i.dropDown,'context-menu'),i}return __extends(t,n),t.prototype.refresh=function(t){t===void 0&&(t=!0);this.itemsSource=this._getMenuItems(this._full);n.prototype.refresh.call(this,t)},t.prototype.attach=function(n){var t=this,i;wjcCore.assert(n instanceof wjcGrid.FlexGrid,'Expecting a FlexGrid control...');i=n.hostElement;i.addEventListener('contextmenu',function(r){t._selectField(n,r)&&(r.preventDefault(),t.owner=i,t.show(r))})},t.prototype._selectField=function(n,t){var i=n.hitTest(t),r;return i.panel!=n.cells||!i.range.isValid?!1:(r=n.rows[i.row].dataItem,r instanceof CubePivotField&&r.subFields&&r.subFields.length)?!1:(n.select(i.range,!0),!0)},t.prototype._getMenuItems=function(n){for(var t,u,i=n?[{text:'<div class="menu-icon"></div>*',parm:'up'},{text:'<div class="menu-icon"></div>*',parm:'down'},{text:'<div class="menu-icon"></div>*',parm:'first'},{text:'<div class="menu-icon"></div>*',parm:'last'},{text:'<div class="wj-separator"></div>'},{text:'<div class="menu-icon"><span class="wj-glyph-filter"></span></div>*',parm:'filter'},{text:'<div class="menu-icon">&#8801;</div>*',parm:'rows'},{text:'<div class="menu-icon">&#10996;</div>*',parm:'cols'},{text:'<div class="menu-icon">&#931;</div>*',parm:'vals'},{text:'<div class="wj-separator"></div>'},{text:'<div class="menu-icon menu-icon-remove">&#10006;</div>*',parm:'remove'},{text:'<div class="wj-separator"></div>'},{text:'<div class="menu-icon">&#9965;</div>*',parm:'edit'}]:[{text:'<div class="menu-icon"><span class="wj-glyph-filter"></span></div>*',parm:'filter'},{text:'<div class="menu-icon">&#8801;</div>*',parm:'rows'},{text:'<div class="menu-icon">&#10996;</div>*',parm:'cols'},{text:'<div class="menu-icon">&#931;</div>*',parm:'vals'},{text:'<div class="wj-separator"></div>'},{text:'<div class="menu-icon">&#9965;</div>*',parm:'edit'}],r=0;r<i.length;r++)t=i[r],t.parm&&(u=wjcCore.culture.olap._ListContextMenu[t.parm],wjcCore.assert(u,'missing localized text for item '+t.parm),t.text=t.text.replace(/([^>]+$)/,u));return i},t.prototype._execute=function(n){var f=wjcCore.Control.getControl(this.owner),r=f.itemsSource,s=f.selection.row,t=f.rows[s].dataItem,i=t?t.engine:null,e=this._getTargetList(i,n),u,o;switch(n){case'up':case'first':case'down':case'last':i&&(u=r.indexOf(t),o=n=='up'?u-1:n=='first'?0:n=='down'?u+1:n=='last'?r.length:-1,i.deferUpdate(function(){r.removeAt(u);r.insert(o,t)}));break;case'filter':case'rows':case'cols':case'vals':e&&t&&e.push(t);break;case'remove':t&&i.removeField(t);break;case'edit':t&&i.editField(t)}},t.prototype._canExecute=function(n){var i=wjcCore.Control.getControl(this.owner),r=i.selection.row,t=i.rows[r].dataItem,u=t?t.engine:null,f=this._getTargetList(u,n);switch(n){case'up':case'first':return r>0;case'down':case'last':return r<i.rows.length-1;case'filter':case'rows':case'cols':case'vals':return f&&f.indexOf(t)<0;case'edit':return u&&u.allowFieldEditing;case'detail':return t&&!(t instanceof CubePivotField)}return!0},t.prototype._getTargetList=function(n,t){if(n)switch(t){case'filter':return n.filterFields;case'rows':return n.rowFields;case'cols':return n.columnFields;case'vals':return n.valueFields}return null},t}(wjcInput.Menu);exports._ListContextMenu=_ListContextMenu;wjcCore.culture.olap=wjcCore.culture.olap||{};wjcCore.culture.olap.PivotPanel=window.wijmo.culture.olap.PivotPanel||{fields:'Choose fields to add to report:',drag:'Drag fields between areas below:',filters:'Filters',cols:'Columns',rows:'Rows',vals:'Values',defer:'Defer Updates',update:'Update'};PivotPanel=function(n){function t(t,i){var r=n.call(this,t,null,!0)||this,e,o,f,u;return r.itemsSourceChanged=new wjcCore.Event,r.viewDefinitionChanged=new wjcCore.Event,r.updatingView=new wjcCore.Event,r.updatedView=new wjcCore.Event,e='Missing dependency: PivotPanel requires ',wjcCore.assert(wjcInput!=null,e+'wijmo.input.'),wjcCore.assert(wjcGrid!=null&&wjcGridFilter!=null,e+'wijmo.grid.filter.'),o=r.getTemplate(),r.applyTemplate('wj-control wj-content wj-pivotpanel',o,{_dFields:'d-fields',_dFilters:'d-filters',_dRows:'d-rows',_dCols:'d-cols',_dVals:'d-vals',_dProgress:'d-prog',_btnUpdate:'btn-update',_chkDefer:'chk-defer',_gFlds:'g-flds',_gDrag:'g-drag',_gFlt:'g-flt',_gCols:'g-cols',_gRows:'g-rows',_gVals:'g-vals',_gDefer:'g-defer'}),r._globalize(),f=r.hostElement,r.addEventListener(f,'dragstart',r._dragstart.bind(r)),r.addEventListener(f,'dragover',r._dragover.bind(r)),r.addEventListener(f,'dragleave',r._dragover.bind(r)),r.addEventListener(f,'drop',r._drop.bind(r)),r.addEventListener(f,'dragend',r._dragend.bind(r)),r._lbFields=r._createFieldGrid(r._dFields),r._lbFilters=r._createFieldGrid(r._dFilters),r._lbRows=r._createFieldGrid(r._dRows),r._lbCols=r._createFieldGrid(r._dCols),r._lbVals=r._createFieldGrid(r._dVals),u=r._ctxMenuShort=new _ListContextMenu(!1),u.attach(r._lbFields),u=r._ctxMenuFull=new _ListContextMenu(!0),u.attach(r._lbFilters),u.attach(r._lbRows),u.attach(r._lbCols),u.attach(r._lbVals),r._dMarker=wjcCore.createElement('<div class="wj-marker" style="display:none">&nbsp;</div>'),r.hostElement.appendChild(r._dMarker),r.addEventListener(r._btnUpdate,'click',function(n){r._ng.refresh(!0);n.preventDefault()}),r.addEventListener(r._chkDefer,'click',function(){wjcCore.enable(r._btnUpdate,r._chkDefer.checked);r._chkDefer.checked?r._ng.beginUpdate():r._ng.endUpdate()}),r.engine=new PivotEngine,r.initialize(i),r}return __extends(t,n),Object.defineProperty(t.prototype,"engine",{get:function(){return this._ng},set:function(n){this._ng&&(this._ng.itemsSourceChanged.removeHandler(this._itemsSourceChanged),this._ng.viewDefinitionChanged.removeHandler(this._viewDefinitionChanged),this._ng.updatingView.removeHandler(this._updatingView),this._ng.updatedView.removeHandler(this._updatedView),this._ng.error.removeHandler(this._requestError));n=wjcCore.asType(n,PivotEngine,!1);this._ng=n;this._ng.itemsSourceChanged.addHandler(this._itemsSourceChanged,this);this._ng.viewDefinitionChanged.addHandler(this._viewDefinitionChanged,this);this._ng.updatingView.addHandler(this._updatingView,this);this._ng.updatedView.addHandler(this._updatedView,this);this._ng.error.addHandler(this._requestError,this);this._lbFields.itemsSource=n.fields;this._lbFilters.itemsSource=n.filterFields;this._lbRows.itemsSource=n.rowFields;this._lbCols.itemsSource=n.columnFields;this._lbVals.itemsSource=n.valueFields;this._lbFields.collectionView.filter=function(n){return n.parentField==null}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"itemsSource",{get:function(){return this._ng.itemsSource},set:function(n){this._ng.itemsSource=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"collectionView",{get:function(){return this._ng.collectionView},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pivotView",{get:function(){return this._ng.pivotView},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoGenerateFields",{get:function(){return this.engine.autoGenerateFields},set:function(n){this._ng.autoGenerateFields=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fields",{get:function(){return this._ng.fields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rowFields",{get:function(){return this._ng.rowFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"columnFields",{get:function(){return this._ng.columnFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"valueFields",{get:function(){return this._ng.valueFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterFields",{get:function(){return this._ng.filterFields},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewDefinition",{get:function(){return this._ng.viewDefinition},set:function(n){this._ng.viewDefinition=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isViewDefined",{get:function(){return this._ng.isViewDefined},enumerable:!0,configurable:!0}),t.prototype.onItemsSourceChanged=function(n){this.itemsSourceChanged.raise(this,n)},t.prototype.onViewDefinitionChanged=function(n){this.viewDefinitionChanged.raise(this,n)},t.prototype.onUpdatingView=function(n){this.updatingView.raise(this,n)},t.prototype.onUpdatedView=function(n){this.updatedView.raise(this,n)},t.prototype.refresh=function(t){t===void 0&&(t=!0);this._lbFields.refresh();this._lbFilters.refresh();this._lbRows.refresh();this._lbCols.refresh();this._lbVals.refresh();t&&(this._globalize(),this._ctxMenuShort.refresh(),this._ctxMenuFull.refresh());n.prototype.refresh.call(this,t)},t.prototype._copy=function(n,t){switch(n){case'engine':return this.engine=t,!0}return!1},t.prototype._globalize=function(){var n=wjcCore.culture.olap.PivotPanel;this._gFlds.textContent=n.fields;this._gDrag.textContent=n.drag;this._gFlt.textContent=n.filters;this._gCols.textContent=n.cols;this._gRows.textContent=n.rows;this._gVals.textContent=n.vals;this._gDefer.textContent=n.defer;this._btnUpdate.textContent=n.update},t.prototype._itemsSourceChanged=function(n,t){this.onItemsSourceChanged(t)},t.prototype._viewDefinitionChanged=function(n,t){if(!n.isUpdating){this.invalidate();this.onViewDefinitionChanged(t)}},t.prototype._updatingView=function(n,t){var i=wjcCore.clamp(t.progress,5,100)%100;this._dProgress.style.width=i+'%';this.onUpdatingView(t)},t.prototype._updatedView=function(n,t){this.onUpdatedView(t)},t.prototype._requestError=function(){this._dProgress.style.width='0'},t.prototype._createFieldGrid=function(n){var i=this,t=new wjcGrid.FlexGrid(n,{autoGenerateColumns:!1,childItemsPath:'subFields',columns:[{binding:'header',width:'*'}],headersVisibility:'None',selectionMode:'Cell',showAlternatingRows:!1}),r=n.querySelector('[wj-part=root]');return r.style.overflowX='hidden',t.formatItem.addHandler(function(n,t){var r=n.rows[t.row].dataItem,f,u;wjcCore.assert(r instanceof PivotField,'PivotField expected...');f=r instanceof CubePivotField&&r.subFields!=null&&r.subFields.length>0;wjcCore.toggleClass(t.cell,'wj-header',f);t.cell.setAttribute('draggable',(!f).toString());u=t.cell.innerHTML;r.filter.isActive&&(u+='&nbsp;&nbsp;<span class="wj-glyph-filter"></span>');n==i._lbVals&&(u+=' <span class="wj-aggregate">('+wjcCore.Aggregate[r.aggregate]+')</span>');n!=i._lbFields||f||(u='<label><input type="checkbox"'+(r.isActive?' checked':'')+'> '+u+'</label>');t.cell.innerHTML=u}),t.addEventListener(n,'click',function(n){var r=n.target,i,u;r instanceof HTMLInputElement&&r.type=='checkbox'&&(i=t.selection,u=i&&i.row>-1?t.rows[i.row].dataItem:null,u instanceof PivotField&&(u.isActive=r.checked))}),t},t.prototype._dragstart=function(n){var t=this._getFlexGridTarget(n);t&&(this._dragField=this._hitTestField(t,n),this._dragSource=this._dragField instanceof PivotField?t.hostElement:null,this._dragSource&&n.dataTransfer&&(wjcCore._startDrag(n.dataTransfer,'copyMove'),n.stopPropagation()))},t.prototype._dragover=function(n){var i=!1,t=this._getFlexGridTarget(n),r,u;t&&this._dragField&&(this._dragSource==this._dFields&&t!=this._lbFields&&(r=t.itemsSource,(r.maxItems==null||r.length<r.maxItems)&&(u=this._dragField,t.itemsSource.indexOf(u)<0?i=!0:t==this._lbVals&&(i=u instanceof CubePivotField?!1:!0))),this._dragSource&&this._dragSource!=this._dFields&&(i=!0));i?(this._updateDropMarker(t,n),n.dataTransfer.dropEffect=this._dragSource==this._dFields?'copy':'move',n.preventDefault(),n.stopPropagation()):this._updateDropMarker()},t.prototype._drop=function(n){var r=this,i=this._getFlexGridTarget(n),u,t;i&&this._dragField&&(u=wjcCore.Control.getControl(this._dragSource),t=this._dragField,u==this._lbFields&&i==this._lbVals&&i.itemsSource.indexOf(t)>-1&&(t=t._clone(),this.engine.fields.push(t)),i==this._lbFields?t.isActive=!1:this._ng.deferUpdate(function(){var u=i.itemsSource,n=u.indexOf(t);n!=r._dropIndex&&(n>-1&&(u.removeAt(n),n<r._dropIndex&&r._dropIndex--),u.insert(r._dropIndex,t))}));this._resetMouseState()},t.prototype._dragend=function(){this._resetMouseState()},t.prototype._hitTestField=function(n,t){var i=n.hitTest(t);return i.panel==n.cells&&i.range.isValid?(n.select(i.range,!0),n.rows[i.row].dataItem):null},t.prototype._resetMouseState=function(){this._dragSource=null;this._updateDropMarker()},t.prototype._getFlexGridTarget=function(n){var t=wjcCore.Control.getControl(wjcCore.closest(n.target,'.wj-flexgrid'));return t instanceof wjcGrid.FlexGrid?t:null},t.prototype._updateDropMarker=function(n,t){var i,u,r,f;if(!t){this._dMarker.style.display='none';return}n.rows.length?(u=n.hitTest(t),r=u.row,r>-1?(i=n.getCellBoundingRect(r,0),u.point.y>i.top+i.height/2&&(i.top+=i.height,r++),this._dropIndex=r):(r=n.viewRange.bottomRow,i=n.getCellBoundingRect(r,0),i.top+=i.height,this._dropIndex=r+1)):(i=wjcCore.Rect.fromBoundingRect(n.hostElement.getBoundingClientRect()),i.top+=4,this._dropIndex=0);f=this.hostElement.getBoundingClientRect();wjcCore.setCss(this._dMarker,{left:Math.round(i.left-f.left),top:Math.round(i.top-f.top-2),width:Math.round(i.width),height:4,display:''})},t}(wjcCore.Control);PivotPanel.controlTemplate='<div><label wj-part="g-flds"><\/label><div wj-part="d-fields"><\/div><label wj-part="g-drag"><\/label><table><tr><td width="50%"><label><span class="wj-glyph wj-glyph-filter"><\/span> <span wj-part="g-flt"><\/span><\/label><div wj-part="d-filters"><\/div><\/td><td width= "50%" style= "border-left-style:solid"><label><span class="wj-glyph">&#10996;<\/span> <span wj-part="g-cols"><\/span><\/label><div wj-part="d-cols"><\/div><\/td><\/tr><tr style= "border-top-style:solid"><td width="50%"><label><span class="wj-glyph">&#8801;<\/span> <span wj-part="g-rows"><\/span><\/label><div wj-part="d-rows"><\/div><\/td><td width= "50%" style= "border-left-style:solid"><label><span class="wj-glyph">&#931;<\/span> <span wj-part="g-vals"><\/span><\/label><div wj-part="d-vals"><\/div><\/td><\/tr><\/table><div wj-part="d-prog" class="wj-state-selected" style="width:0px;height:3px"><\/div><div style="display:table"><label style="display:table-cell;vertical-align:middle"><input wj-part="chk-defer" type="checkbox"/> <span wj-part="g-defer"><\/span><\/label><a wj-part="btn-update" href="" draggable="false" disabled class="wj-state-disabled"><\/a><\/div><\/div>';exports.PivotPanel=PivotPanel;_GridContextMenu=function(n){function t(){var t=n.call(this,document.createElement('div'),{header:'PivotGrid Context Menu',displayMemberPath:'text',commandParameterPath:'parm',command:{executeCommand:function(n){t._execute(n)},canExecuteCommand:function(n){return t._canExecute(n)}}})||this;return t.itemsSource=t._getMenuItems(),wjcCore.addClass(t.dropDown,'context-menu'),t}return __extends(t,n),t.prototype.refresh=function(t){t===void 0&&(t=!0);this.itemsSource=this._getMenuItems();n.prototype.refresh.call(this,t)},t.prototype.attach=function(n){var t=this,i;wjcCore.assert(n instanceof PivotGrid,'Expecting a PivotGrid control...');i=n.hostElement;i.addEventListener('contextmenu',function(r){if(n.customContextMenu&&(r.preventDefault(),t.owner=i,t._selectField(r))){var u=t.dropDown;t.selectedIndex=-1;t.onIsDroppedDownChanging(new wjcCore.CancelEventArgs)&&(wjcCore.showPopup(u,r),t.onIsDroppedDownChanged(),u.focus())}})},t.prototype._selectField=function(n){this._targetField=null;this._htDown=null;var r=wjcCore.Control.getControl(this.owner),i=r.engine,t=r.hitTest(n);switch(t.cellType){case wjcGrid.CellType.Cell:r.select(t.range);this._targetField=i.valueFields[t.col%i.valueFields.length];this._htDown=t;break;case wjcGrid.CellType.ColumnHeader:this._targetField=i.columnFields[t.row];break;case wjcGrid.CellType.RowHeader:this._targetField=i.rowFields[t.col];break;case wjcGrid.CellType.TopLeft:t.row==t.panel.rows.length-1&&(this._targetField=i.rowFields[t.col])}return this._targetField!=null},t.prototype._getMenuItems=function(){for(var n,r,t=[{text:'<div class="menu-icon menu-icon-remove">&#10006;</div>Remove Field',parm:'remove'},{text:'<div class="menu-icon">&#9965;</div>Field Settings...',parm:'edit'},{text:'<div class="wj-separator"></div>'},{text:'<div class="menu-icon">&#8981;</div>Show Detail...',parm:'detail'}],i=0;i<t.length;i++)n=t[i],n.parm&&(r=wjcCore.culture.olap._ListContextMenu[n.parm],wjcCore.assert(r,'missing localized text for item '+n.parm),n.text=n.text.replace(/([^>]+$)/,r));return t},t.prototype._execute=function(n){var t=wjcCore.Control.getControl(this.owner),i=this._targetField,r=this._htDown;switch(n){case'remove':t.engine.removeField(i);break;case'edit':t.engine.editField(i);break;case'detail':t.showDetail(r.row,r.col)}},t.prototype._canExecute=function(n){var i=wjcCore.Control.getControl(this.owner),r=i.engine,t=this._targetField;switch(n){case'remove':return t!=null;case'edit':return t!=null&&i.engine.allowFieldEditing;case'detail':return this._htDown!=null&&t!=null&&!(t instanceof CubePivotField)}return!0},t}(wjcInput.Menu);exports._GridContextMenu=_GridContextMenu;_PivotMergeManager=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.getMergedRange=function(t,i,r,u){u===void 0&&(u=!0);var f=t.grid.collectionView;if(this._ng=f instanceof PivotCollectionView?f.engine:null,!this._ng)return n.prototype.getMergedRange.call(this,t,i,r,u);switch(t.cellType){case wjcGrid.CellType.TopLeft:return this._getMergedTopLeftRange(t,i,r);case wjcGrid.CellType.RowHeader:return this._getMergedRowHeaderRange(t,i,r,u?t.viewRange:null);case wjcGrid.CellType.ColumnHeader:return this._getMergedColumnHeaderRange(t,i,r,u?t.viewRange:null)}return null},t.prototype._getMergedTopLeftRange=function(n,t,i){for(var r=new wjcGrid.CellRange(t,i);r.col>0&&!n.getCellData(t,r.col,!0);)r.col--;while(r.col2<n.columns.length-1&&!n.getCellData(t,r.col2+1,!0))r.col2++;return r},t.prototype._getMergedRowHeaderRange=function(n,t,i,r){var s=n.getCellData(t,i,!1),h=this._ng._getRowLevel(t),e,o,c,l;if(h>-1&&i>=h){for(var u=void 0,f=void 0,a=r?r.col:0,v=r?r.col2:n.columns.length-1,u=i;u>a;u--)if(n.getCellData(t,u-1,!1)!=s)break;for(f=i;f<v;f++)if(n.getCellData(t,f+1,!1)!=s)break;return u!=f?new wjcGrid.CellRange(t,u,t,f):null}for(c=r?r.row:0,l=r?r.row2:n.rows.length-1,e=t;e>c;e--)if(!this._sameColumnValues(n,t,e-1,i))break;for(o=t;o<l;o++)if(!this._sameColumnValues(n,t,o+1,i))break;return e!=o?new wjcGrid.CellRange(e,i,o,i):null},t.prototype._sameColumnValues=function(n,t,i,r){for(;r>=0;r--){var u=n.getCellData(t,r,!1),f=n.getCellData(i,r,!1);if(u!=f)return!1}return!0},t.prototype._getMergedColumnHeaderRange=function(n,t,i,r){var a=this._ng._getKey(n.columns[i].binding),s=n.getCellData(t,i,!1),h=this._ng._getColLevel(a),e,o,c,l;if(h>-1&&t>=h){for(var u=void 0,f=void 0,v=r?r.row:0,y=r?r.row2:n.rows.length-1,u=t;u>v;u--)if(n.getCellData(u-1,i,!1)!=s)break;for(f=t;f<y;f++)if(n.getCellData(f+1,i,!1)!=s)break;if(u!=f)return new wjcGrid.CellRange(u,i,f,i)}for(c=r?r.col:0,l=r?r.col2:n.columns.length-1,e=i;e>c;e--)if(!this._sameRowValues(n,t,i,e-1))break;for(o=i;o<l;o++)if(!this._sameRowValues(n,t,i,o+1))break;return e!=o?new wjcGrid.CellRange(t,e,t,o):null},t.prototype._sameRowValues=function(n,t,i,r){for(;t>=0;t--){var u=n.getCellData(t,i,!1),f=n.getCellData(t,r,!1);if(u!=f)return!1}return!0},t}(wjcGrid.MergeManager);exports._PivotMergeManager=_PivotMergeManager;PivotGrid=function(n){function t(t,i){var r=n.call(this,t)||this;return r._showDetailOnDoubleClick=!0,r._collapsibleSubtotals=!0,r._customCtxMenu=!0,r._showRowFldSort=!1,r._showRowFldHdrs=!0,r._showColFldHdrs=!0,r._centerVert=!0,wjcCore.addClass(r.hostElement,'wj-pivotgrid'),r.isReadOnly=!0,r.deferResizing=!0,r.showAlternatingRows=!1,r.autoGenerateColumns=!1,r.allowDragging=wjcGrid.AllowDragging.None,r.mergeManager=new _PivotMergeManager(r),r.customContextMenu=!0,r.initialize(i),r.formatItem.addHandler(r._formatItem,r),r.addEventListener(r.hostElement,'mousedown',r._mousedown.bind(r),!0),r.addEventListener(r.hostElement,'mouseup',r._mouseup.bind(r),!0),r.addEventListener(r.hostElement,'dblclick',r._dblclick.bind(r),!0),r._ctxMenu=new _GridContextMenu,r._ctxMenu.attach(r),r}return __extends(t,n),Object.defineProperty(t.prototype,"engine",{get:function(){return this._ng},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showDetailOnDoubleClick",{get:function(){return this._showDetailOnDoubleClick},set:function(n){this._showDetailOnDoubleClick=wjcCore.asBoolean(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showRowFieldHeaders",{get:function(){return this._showRowFldHdrs},set:function(n){n!=this._showRowFldHdrs&&(this._showRowFldHdrs=wjcCore.asBoolean(n),this._updateFixedContent())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showColumnFieldHeaders",{get:function(){return this._showColFldHdrs},set:function(n){n!=this._showColFldHdrs&&(this._showColFldHdrs=wjcCore.asBoolean(n),this._updateFixedContent())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showRowFieldSort",{get:function(){return this._showRowFldSort},set:function(n){n!=this._showRowFldSort&&(this._showRowFldSort=wjcCore.asBoolean(n),this.invalidate())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"customContextMenu",{get:function(){return this._customCtxMenu},set:function(n){this._customCtxMenu=wjcCore.asBoolean(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"collapsibleSubtotals",{get:function(){return this._collapsibleSubtotals},set:function(n){n!=this._collapsibleSubtotals&&(this._collapsibleSubtotals=wjcCore.asBoolean(n),this.invalidate())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"centerHeadersVertically",{get:function(){return this._centerVert},set:function(n){n!=this._centerVert&&(this._centerVert=wjcCore.asBoolean(n),this.invalidate())},enumerable:!0,configurable:!0}),t.prototype.getDetail=function(n,t){var i=this.rows[wjcCore.asInt(n)].dataItem,r=this.columns[wjcCore.asInt(t)].binding;return this._ng.getDetail(i,r)},t.prototype.getKeys=function(n,t){var i=this.rows[wjcCore.asInt(n)].dataItem,r=this.columns[wjcCore.asInt(t)].binding;return this._ng.getKeys(i,r)},t.prototype.getDetailView=function(n,t){var i=this.rows[wjcCore.asInt(n)].dataItem,r=this.columns[wjcCore.asInt(t)].binding;return this._ng.getDetailView(i,r)},t.prototype.showDetail=function(n,t){var r=new DetailDialog(document.createElement('div')),i;r.showDetail(this,new wjcGrid.CellRange(n,t));i=new wjcInput.Popup(document.createElement('div'));i.content=r.hostElement;i.show(!0)},t.prototype.collapseRowsToLevel=function(n){this._collapseRowsToLevel(n)},t.prototype.collapseColumnsToLevel=function(n){this._collapseColsToLevel(n)},t.prototype.refresh=function(t){t===void 0&&(t=!0);this._ctxMenu.refresh();n.prototype.refresh.call(this,t)},t.prototype._getCollectionView=function(n){return n instanceof PivotPanel?n=n.engine.pivotView:n instanceof PivotEngine&&(n=n.pivotView),wjcCore.asCollectionView(n)},t.prototype.onItemsSourceChanged=function(t){this._ng&&this._ng.updatedView.removeHandler(this._updatedView,this);var i=this.collectionView;this._ng=i instanceof PivotCollectionView?i.engine:null;this._ng&&this._ng.updatedView.addHandler(this._updatedView,this);this._updatedView();n.prototype.onItemsSourceChanged.call(this,t)},t.prototype.onResizedColumn=function(t){var i=this._ng,r;i&&(t.panel==this.topLeftCells&&t.col<i.rowFields.length&&(r=i.rowFields[t.col],r.width=t.panel.columns[t.col].renderWidth),t.panel==this.columnHeaders&&i.valueFields.length>0&&(r=i.valueFields[t.col%i.valueFields.length],r.width=t.panel.columns[t.col].renderWidth));n.prototype.onResizedColumn.call(this,t)},t.prototype._updatedView=function(){this._updateFixedCounts();this.columns.clear();this.rows.clear()},t.prototype.onLoadedRows=function(t){var r,u,i,f;if(this.columns.length==0&&(r=this.collectionView,r&&r.items.length)){u=r.items[0];for(i in u)i!=_PivotKey._ROW_KEY_NAME&&(f=new wjcGrid.Column({binding:i,dataType:u[i]!=null?wjcCore.getType(u[i]):wjcCore.DataType.Number}),this.columns.push(f))}this._updateFixedContent();n.prototype.onLoadedRows.call(this,t)},t.prototype._updateFixedCounts=function(){var n=this._ng,i=n&&n.isViewDefined,t;t=Math.max(1,i?n.rowFields.length:1);this._setLength(this.topLeftCells.columns,t);t=Math.max(1,i?n.columnFields.length:1);n&&n.columnFields.length&&n.valueFields.length>1&&t++;this._setLength(this.topLeftCells.rows,t)},t.prototype._setLength=function(n,t){while(n.length<t)n.push(n instanceof wjcGrid.ColumnCollection?new wjcGrid.Column:new wjcGrid.Row);while(n.length>t)n.removeAt(n.length-1)},t.prototype._updateFixedContent=function(){var r=this._ng,s=r&&r.isViewDefined,t,o,i,f,n,e,u;if(!s){this.topLeftCells.setCellData(0,0,null);return}for(t=this.topLeftCells,i=0;i<t.rows.length;i++)for(n=0;n<t.columns.length;n++)f='',this.showRowFieldHeaders&&n<r.rowFields.length&&i==t.rows.length-1&&(f=r.rowFields[n].header),this.showColumnFieldHeaders&&!f&&i<r.columnFields.length&&n==0&&(f=r.columnFields[i].header+':'),t.setCellData(i,n,f,!1,!1);for(t=this.rowHeaders,i=0;i<t.rows.length;i++)for(o=t.rows[i].dataItem[_PivotKey._ROW_KEY_NAME],wjcCore.assert(o instanceof _PivotKey,'missing PivotKey for row...'),n=0;n<t.columns.length;n++)f=o.getValue(n,!0),t.setCellData(i,n,f,!1,!1);for(t=this.columnHeaders,n=0;n<t.columns.length;n++)for(o=r._getKey(t.columns[n].binding),wjcCore.assert(o instanceof _PivotKey,'missing PivotKey for column...'),i=0;i<t.rows.length;i++)f=i==t.rows.length-1&&r.valueFields.length>1?r.valueFields[n%r.valueFields.length].header:o.getValue(i,!0),t.setCellData(i,n,f,!1,!1);for(t=this.topLeftCells,n=0;n<t.columns.length;n++)e=t.columns[n],u=n<r.rowFields.length?r.rowFields[n]:null,e.width=u&&wjcCore.isNumber(u.width)?u.width:this.columns.defaultSize,e.wordWrap=u?u.wordWrap:null,e.align=null;for(t=this.cells,n=0;n<t.columns.length;n++)e=t.columns[n],u=r.valueFields.length?r.valueFields[n%r.valueFields.length]:null,e.width=u&&wjcCore.isNumber(u.width)?u.width:this.columns.defaultSize,e.wordWrap=u?u.wordWrap:null,e.format=u?u.format:null},t.prototype._formatItem=function(n,t){var i=this._ng,f,e,o,r,u,s;i&&(t.panel==this.topLeftCells&&(t.cell.style.textAlign='',f=t.row<t.panel.rows.length-1||i.rowFields.length==0,wjcCore.toggleClass(t.cell,'wj-col-field-hdr',f),wjcCore.toggleClass(t.cell,'wj-row-field-hdr',!f)),t.panel==this.columnHeaders&&(i.valueFields.length<2||t.row<t.panel.rows.length-1)&&(t.cell.style.textAlign=''),e=i._getRowLevel(t.row),o=i._getColLevel(t.panel.columns[t.col].binding),wjcCore.toggleClass(t.cell,'wj-aggregate',e>-1||o>-1),this._collapsibleSubtotals&&(t.panel==this.rowHeaders&&i.showRowTotals==ShowTotals.Subtotals&&(r=this.getMergedRange(t.panel,t.row,t.col,!1)||t.range,t.col<i.rowFields.length-1&&r.rowSpan>1&&(t.cell.innerHTML=this._getCollapsedGlyph(this._getRowCollapsed(r))+t.cell.innerHTML)),t.panel==this.columnHeaders&&i.showColumnTotals==ShowTotals.Subtotals&&(r=this.getMergedRange(t.panel,t.row,t.col,!1)||t.range,t.row<i.columnFields.length-1&&r.columnSpan>1&&(t.cell.innerHTML=this._getCollapsedGlyph(this._getColCollapsed(r))+t.cell.innerHTML))),t.panel==this.topLeftCells&&this.showRowFieldSort&&t.col<i.rowFields.length&&t.row==this._getSortRowIndex()&&(u=i.rowFields[t.col],wjcCore.toggleClass(t.cell,'wj-sort-asc',!u.descending),wjcCore.toggleClass(t.cell,'wj-sort-desc',u.descending),t.cell.innerHTML+=' <span class="wj-glyph-'+(u.descending?'down':'up')+'"></span>'),this._centerVert&&t.cell.hasChildNodes&&(t.panel==this.rowHeaders||t.panel==this.columnHeaders)&&(s=wjcCore.createElement('<div style="display:table-cell;vertical-align:middle"></div>'),this._docRange||(this._docRange=document.createRange()),this._docRange.selectNodeContents(t.cell),this._docRange.surroundContents(s),wjcCore.setCss(t.cell,{display:'table',tableLayout:'fixed',paddingTop:0,paddingBottom:0})))},t.prototype._getCollapsedGlyph=function(n){return'<div style="display:inline-block;cursor:pointer" '+t._WJA_COLLAPSE+'><span class="wj-glyph-'+(n?'plus':'minus')+'"><\/span><\/div>&nbsp'},t.prototype._mousedown=function(n){var u,i,r;if(n.defaultPrevented||n.button!=0){this._htDown=null;return}if(this._htDown=this.hitTest(n),u=wjcCore.closest(n.target,'['+t._WJA_COLLAPSE+']'),u!=null&&this._htDown.panel!=null){i=this._htDown.range;r=void 0;switch(this._htDown.panel.cellType){case wjcGrid.CellType.RowHeader:r=this._getRowCollapsed(i);n.shiftKey||n.ctrlKey?this._collapseRowsToLevel(i.col+(r?2:1)):this._setRowCollapsed(i,!r);break;case wjcGrid.CellType.ColumnHeader:r=this._getColCollapsed(i);n.shiftKey||n.ctrlKey?this._collapseColsToLevel(i.row+(r?2:1)):this._setColCollapsed(i,!r)}this._htDown=null;n.preventDefault()}},t.prototype._mouseup=function(n){var t,i,r,u,f;if(this._htDown&&!n.defaultPrevented&&this.hostElement.style.cursor!='col-resize'&&(t=this.hitTest(n),this._htDown.panel==t.panel&&t.range.equals(this._htDown.range))&&(i=this._ng,r=this.topLeftCells,t.panel==r&&t.row==r.rows.length-1&&t.col>-1)){if(this.allowSorting&&t.panel.columns[t.col].allowSorting&&(u=new wjcGrid.CellRangeEventArgs(t.panel,t.range),this.onSortingColumn(u))){i.pivotView.sortDescriptions.clear();f=i.rowFields[t.col];f.descending=!f.descending;this.onSortedColumn(u)}n.preventDefault()}},t.prototype._dblclick=function(n){if(this._ng&&this._ng.fields.length>0&&!(this._ng.fields[0]instanceof CubePivotField)&&!n.defaultPrevented&&this._showDetailOnDoubleClick){var t=this._htDown;t&&t.panel==this.cells&&this.showDetail(t.row,t.col)}},t.prototype._getRowLevel=function(n){return this._ng._getRowLevel(n)},t.prototype._getGroupedRows=function(n){var u=n.col+1,i,t,r;if(this._ng.totalsBeforeData){for(t=n.row;t<this.rows.length-1;t++)if(r=this._getRowLevel(t+1),r>-1&&r<=u)break;for(i=t;i>0;i--)if(this._getRowLevel(i)==u)break;i++}else{for(i=n.row;i>0;i--)if(r=this._getRowLevel(i-1),r>-1&&r<=u)break;for(t=i;t<this.rows.length;t++)if(this._getRowLevel(t)==u)break;t==this.rows.length&&t--;t--}return t>=i?new wjcGrid.CellRange(i,n.col,t,n.col2):n},t.prototype._getRowCollapsed=function(n){n=this._getGroupedRows(n);for(var t=n.row;t<=n.row2;t++)if(this.rows[t].visible)return!1;return!0},t.prototype._setRowCollapsed=function(n,t){var i=this;this.deferUpdate(function(){n=i._getGroupedRows(n);for(var r=n.row;r<=n.row2;r++)i.rows[r].visible=!t})},t.prototype._toggleRowCollapsed=function(n){this._setRowCollapsed(n,!this._getRowCollapsed(n))},t.prototype._collapseRowsToLevel=function(n){var t=this;n>=this._ng.rowFields.length&&(n=-1);this.deferUpdate(function(){for(var u,r,i=0;i<t.rows.length;i++)n<0?t.rows[i].visible=!0:(u=t._getRowLevel(i),r=u>-1&&u<=n,r||(t._ng.totalsBeforeData?i==0&&(r=!0):i==t.rows.length-1&&(r=!0)),t.rows[i].visible=r)})},t.prototype._getColLevel=function(n){return this._ng._getColLevel(this.columns[n].binding)},t.prototype._getGroupedCols=function(n){var u=n.row+1,t,i,r;if(this._ng.totalsBeforeData){for(i=n.col;i<this.columns.length-1;i++)if(r=this._getColLevel(i+1),r>-1&&r<=u)break;for(t=i;t>0;t--)if(this._getColLevel(t)==u)break;t++}else{for(t=n.col;t>0;t--)if(r=this._getColLevel(t-1),r>-1&&r<=u)break;for(i=t;i<this.columns.length;i++)if(this._getColLevel(i)==u)break;i--}return i>=t?new wjcGrid.CellRange(n.row,t,n.row2,i):n},t.prototype._getColCollapsed=function(n){n=this._getGroupedCols(n);for(var t=n.col;t<=n.col2;t++)if(this.columns[t].visible)return!1;return!0},t.prototype._setColCollapsed=function(n,t){var i=this;this.deferUpdate(function(){n=i._getGroupedCols(n);for(var r=n.col;r<=n.col2;r++)i.columns[r].visible=!t})},t.prototype._toggleColCollapsed=function(n){this._setColCollapsed(n,!this._getColCollapsed(n))},t.prototype._collapseColsToLevel=function(n){var t=this;n>=this._ng.columnFields.length&&(n=-1);this.deferUpdate(function(){for(var r,i=0;i<t.columns.length;i++)n<0?t.columns[i].visible=!0:(r=t._getColLevel(i),t.columns[i].visible=r>-1&&r<=n)})},t}(wjcGrid.FlexGrid);PivotGrid._WJA_COLLAPSE='wj-pivot-collapse';exports.PivotGrid=PivotGrid;wjcCore.culture.olap=wjcCore.culture.olap||{};wjcCore.culture.olap.DetailDialog=window.wijmo.culture.olap.DetailDialog||{header:'Detail View:',ok:'OK',items:'{cnt:n0} items',item:'{cnt} item',row:'Row',col:'Column'};DetailDialog=function(n){function t(t,i){var r=n.call(this,t,null,!0)||this,f=r.getTemplate(),u;return r.applyTemplate('wj-control wj-content wj-detaildialog',f,{_sCnt:'sp-cnt',_dSummary:'div-summary',_dGrid:'div-grid',_btnOK:'btn-ok',_gHdr:'g-hdr'}),u=wjcCore.culture.olap.DetailDialog,r._gHdr.textContent=u.header,r._btnOK.textContent=u.ok,r._g=new wjcGrid.FlexGrid(r._dGrid,{isReadOnly:!0}),r.initialize(i),r}return __extends(t,n),t.prototype.showDetail=function(n,t){var l=this,i=n.getDetailView(t.row,t.col),u,h,f;this._g.itemsSource=i;u=wjcCore.tryCast(i,'IPagedCollectionView');this._updateDetailCount(u?u.totalItemCount:i.items.length);i.collectionChanged.addHandler(function(){l._updateDetailCount(i.items.length)});var e=n.engine,o=wjcCore.culture.olap.DetailDialog,r='',a=n.rows[t.row].dataItem[_PivotKey._ROW_KEY_NAME],s=this._getHeader(a);s&&(r+=o.row+': <b>'+wjcCore.escapeHtml(s)+'</b><br>');h=e._getKey(n.columns[t.col].binding);f=this._getHeader(h);f&&(r+=o.col+': <b>'+wjcCore.escapeHtml(f)+'</b><br>');var c=e.valueFields,v=c[t.col%c.length],y=v.header,p=n.getCellData(t.row,t.col,!0);r+=wjcCore.escapeHtml(y)+': <b>'+wjcCore.escapeHtml(p)+'</b>';this._dSummary.innerHTML=r},t.prototype._updateDetailCount=function(n){var t=wjcCore.culture.olap.DetailDialog;this._sCnt.textContent=wjcCore.format(n==1?t.item:t.items,{cnt:n})},t.prototype._getHeader=function(n){var i,t;if(n.values.length){for(i=[],t=0;t<n.values.length;t++)i.push(n.getValue(t,!0));return i.join(' - ')}return null},t}(wjcCore.Control);DetailDialog.controlTemplate='<div><div class="wj-dialog-header"><span wj-part="g-hdr">Detail View:<\/span> <span wj-part="sp-cnt"><\/span><\/div><div class="wj-dialog-body"><div wj-part="div-summary"><\/div><div wj-part="div-grid"><\/div><\/div><div class="wj-dialog-footer"><a class="wj-hide" wj-part="btn-ok" href="" draggable="false">OK<\/a>&nbsp;&nbsp;<\/div><\/div>';exports.DetailDialog=DetailDialog;wjcCore.culture.olap=wjcCore.culture.olap||{};wjcCore.culture.olap.PivotChart=window.wijmo.culture.olap.PivotChart||{by:'by',and:'and'},function(n){n[n.Column=0]="Column";n[n.Bar=1]="Bar";n[n.Scatter=2]="Scatter";n[n.Line=3]="Line";n[n.Area=4]="Area";n[n.Pie=5]="Pie"}(PivotChartType=exports.PivotChartType||(exports.PivotChartType={})),function(n){n[n.Always=0]="Always";n[n.Never=1]="Never";n[n.Auto=2]="Auto"}(LegendVisibility=exports.LegendVisibility||(exports.LegendVisibility={}));PivotChart=function(n){function t(i,r){var u=n.call(this,i)||this;return u._chartType=PivotChartType.Column,u._showHierarchicalAxes=!0,u._showTotals=!1,u._showTitle=!0,u._showLegend=LegendVisibility.Always,u._legendPosition=wjcChart.Position.Right,u._maxSeries=t.MAX_SERIES,u._maxPoints=t.MAX_POINTS,u._stacking=wjcChart.Stacking.None,u._colItms=[],u._dataItms=[],u._lblsSrc=[],u._grpLblsSrc=[],wjcCore.addClass(u.hostElement,'wj-pivotchart'),u._isPieChart()?u._createFlexPie():u._createFlexChart(),n.prototype.initialize.call(u,r),u}return __extends(t,n),Object.defineProperty(t.prototype,"engine",{get:function(){return this._ng},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"itemsSource",{get:function(){return this._itemsSource},set:function(n){if(n&&this._itemsSource!==n){var t=this._itemsSource;n instanceof PivotPanel?n=n.engine.pivotView:n instanceof PivotEngine&&(n=n.pivotView);this._itemsSource=wjcCore.asCollectionView(n);this._onItemsSourceChanged(t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"chartType",{get:function(){return this._chartType},set:function(n){n!=this._chartType&&(this._chartType=wjcCore.asEnum(n,PivotChartType),this._changeChartType())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showHierarchicalAxes",{get:function(){return this._showHierarchicalAxes},set:function(n){n!=this._showHierarchicalAxes&&(this._showHierarchicalAxes=wjcCore.asBoolean(n,!0),!this._isPieChart()&&this._flexChart&&this._updateFlexChart(this._dataItms,this._lblsSrc,this._grpLblsSrc))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showTotals",{get:function(){return this._showTotals},set:function(n){n!=this._showTotals&&(this._showTotals=wjcCore.asBoolean(n,!0),this._updatePivotChart())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showTitle",{get:function(){return this._showTitle},set:function(n){n!=this._showTitle&&(this._showTitle=wjcCore.asBoolean(n,!0),this._updatePivotChart())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showLegend",{get:function(){return this._showLegend},set:function(n){n!=this.showLegend&&(this._showLegend=wjcCore.asEnum(n,LegendVisibility),this._updatePivotChart())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"legendPosition",{get:function(){return this._legendPosition},set:function(n){n!=this.legendPosition&&(this._legendPosition=wjcCore.asEnum(n,wjcChart.Position),this._updatePivotChart());return},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stacking",{get:function(){return this._stacking},set:function(n){n!=this._stacking&&(this._stacking=wjcCore.asEnum(n,wjcChart.Stacking),this._flexChart&&(this._flexChart.stacking=this._stacking,this._updatePivotChart()))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSeries",{get:function(){return this._maxSeries},set:function(n){n!=this._maxSeries&&(this._maxSeries=wjcCore.asNumber(n),this._updatePivotChart())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxPoints",{get:function(){return this._maxPoints},set:function(n){n!=this._maxPoints&&(this._maxPoints=wjcCore.asNumber(n),this._updatePivotChart())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"flexChart",{get:function(){return this._flexChart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"flexPie",{get:function(){return this._flexPie},enumerable:!0,configurable:!0}),t.prototype.refresh=function(t){t===void 0&&(t=!0);n.prototype.refresh.call(this,t);this._isPieChart()?this._flexPie&&this._flexPie.refresh(t):this._flexChart&&this._flexChart.refresh(t)},t.prototype._onItemsSourceChanged=function(n){this._ng&&this._ng.updatedView.removeHandler(this._updatePivotChart,this);n&&n.collectionChanged.removeHandler(this._updatePivotChart,this);var t=this._itemsSource;this._ng=t instanceof PivotCollectionView?t.engine:null;this._ng&&this._ng.updatedView.addHandler(this._updatePivotChart,this);this._itemsSource&&this._itemsSource.collectionChanged.addHandler(this._updatePivotChart,this);this._updatePivotChart()},t.prototype._createFlexChart=function(){var n=this,t=document.createElement('div');this.hostElement.appendChild(t);this._flexChart=new wjcChart.FlexChart(t);this._flexChart._bindingSeparator=null;this._flexChart.legend.position=wjcChart.Position.Right;this._flexChart.bindingX=_PivotKey._ROW_KEY_NAME;this._flexChart.stacking=this._stacking;this._flexChart.tooltip.content=function(t){var i=t.name?'<b>'+t.name+"<\/b> <br/>":'';return i+(n._getLabel(t.x)+' '+n._getValue(t))};this._flexChart.hostElement.style.visibility='hidden'},t.prototype._createFlexPie=function(){var n=this,i=document.createElement('div'),t;this.hostElement.appendChild(i);this._colMenu=new wjcInput.Menu(i);this._colMenu.displayMemberPath='text';this._colMenu.selectedValuePath='prop';this._colMenu.hostElement.style.visibility='hidden';t=document.createElement('div');this.hostElement.appendChild(t);this._flexPie=new wjcChart.FlexPie(t);this._flexPie.bindingName=_PivotKey._ROW_KEY_NAME;this._flexPie.tooltip.content=function(t){return'<b>'+n._getLabel(n._dataItms[t.pointIndex][_PivotKey._ROW_KEY_NAME])+"<\/b> <br/>"+n._getValue(t)};this._flexPie.rendering.addHandler(this._updatePieInfo,this)},t.prototype._updatePivotChart=function(){var r,u,s,a,e,v,n;if(this._ng&&this._ng.pivotView){var f=[],c=[],t=[],i=0,l,h=this._ng.pivotView,o=this._ng.rowFields;for(r=0;r<h.items.length;r++){if(u=h.items[r],s=u.$rowKey,r==0&&this._getColumns(u),f.length>=this._maxPoints)break;if(!this._isTotalRow(u[_PivotKey._ROW_KEY_NAME])){for(f.push(u),c.push({value:f.length-1,text:this._getLabel(u[_PivotKey._ROW_KEY_NAME])}),n=0;n<o.length;n++)t.length<=n&&t.push([]),a=this._getMergeIndex(s,l),a<n?(i=t[n].length-1,e=t[n][i],i===0&&n<o.length-1&&(e.value=(e.width-1)/2),i>0&&n<o.length-1&&(v=this._getOffsetWidth(t[n]),e.value=v+(e.width-1)/2),t[n].push({value:f.length-1,text:s.getValue(n,!0),width:1})):(i=t[n].length-1,t[n][i].width++);l=s}if(r==h.items.length-1)for(n=0;n<o.length;n++)n<t.length&&(i=t[n].length-1,t[n][i].value=this._getOffsetWidth(t[n])+(t[n][i].width-1)/2)}this._dataItms=f;this._lblsSrc=c;this._grpLblsSrc=t;this._updateFlexChartOrPie()}},t.prototype._updateFlexChartOrPie=function(){var n=this._isPieChart();!n&&this._flexChart?this._updateFlexChart(this._dataItms,this._lblsSrc,this._grpLblsSrc):n&&this._flexPie&&this._updateFlexPie(this._dataItms,this._lblsSrc)},t.prototype._updateFlexChart=function(n,t,i){var r,e,f,u;if(this._ng&&this._flexChart){if(r=this._flexChart,e=r.hostElement,r.beginUpdate(),r.itemsSource=n,r.legend.position=this._getLegendPosition(),this._createSeries(),e.style.visibility=r.series&&r.series.length>0&&n.length>0?'visible':'hidden',r.header=this._getChartTitle(),this._isBarChart()){if(this._showHierarchicalAxes&&i.length>0){if(r.axisY.itemsSource=i[i.length-1],r.axisX.labelAngle=undefined,i.length>=2)for(u=i.length-2;u>=0;u--)this._createGroupAxes(i[u])}else r.axisY.labelAngle=undefined,r.axisY.itemsSource=t;r.axisX.itemsSource=undefined}else{if(this._showHierarchicalAxes&&i.length>0){if(r.axisX.itemsSource=i[i.length-1],i.length>=2)for(u=i.length-2;u>=0;u--)this._createGroupAxes(i[u])}else r.axisX.labelAngle=undefined,r.axisX.itemsSource=t;r.axisY.itemsSource=undefined}r.axisX.labelPadding=6;r.axisY.labelPadding=6;this.chartType===PivotChartType.Bar?(f=r.axisX,r.axisY.reversed=!0):(f=r.axisY,r.axisY.reversed=!1);f.format=r.stacking!==wjcChart.Stacking.Stacked100pc&&this._ng.valueFields.length>0&&this._ng.valueFields[0].format?this._ng.valueFields[0].format:'';r.endUpdate()}},t.prototype._updateFlexPie=function(n){var r;if(this._ng&&this._flexPie){var i=this._flexPie,u=i.hostElement,t=this._colMenu;u.style.visibility=this._colItms.length>0&&n.length>0?'visible':'hidden';i.beginUpdate();i.itemsSource=n;i.bindingName=_PivotKey._ROW_KEY_NAME;this._colItms&&this._colItms.length>0&&(i.binding=this._colItms[0].prop);i.header=this._getChartTitle();i.legend.position=this._getLegendPosition();i.endUpdate();r=this._getTitle(this._ng.columnFields);r!==''&&(r='<b>'+r+': </b>');this._colItms&&this._colItms.length>1&&n.length>0?(t.hostElement.style.visibility='visible',t.header=r+this._colItms[0].text,t.itemsSource=this._colItms,t.command={executeCommand:function(){var n=t.selectedItem;t.header=r+n.text;i.binding=n.prop}},t.selectedIndex=0,t.invalidate(),t.listBox.invalidate()):t.hostElement.style.visibility='hidden'}},t.prototype._getLegendPosition=function(){var n=this.legendPosition,t;return this.showLegend==LegendVisibility.Never?n=wjcChart.Position.None:this.showLegend==LegendVisibility.Auto&&this.flexChart&&this.flexChart.series&&(t=0,this.flexChart.series.forEach(function(n){var i=n.visibility;n.name&&i!=wjcChart.SeriesVisibility.Hidden&&i!=wjcChart.SeriesVisibility.Plot&&t++}),t<2&&(n=wjcChart.Position.None)),n},t.prototype._createSeries=function(){var n,t;for(this._flexChart&&(this._flexChart.series.length=0),n=0;n<this._colItms.length;n++)t=new wjcChart.Series,t.binding=this._colItms[n].prop,t.name=this._colItms[n].text,this._flexChart.series.push(t)},t.prototype._getColumns=function(n){var r=0,i,u,t;if(n){this._colItms.length=0;for(t in n)n.hasOwnProperty(t)&&t!==_PivotKey._ROW_KEY_NAME&&r<this._maxSeries&&(this._showTotals&&this._isTotalColumn(t)||!this._showTotals&&!this._isTotalColumn(t))&&(i=this._ng._getKey(t),u=this._getLabel(i),this._colItms.push({prop:t,text:this._getLabel(i)}),r++)}},t.prototype._createGroupAxes=function(n){var e=this,f=this._flexChart,r=this._isBarChart()?f.axisY:f.axisX,i,u;n&&(i=new wjcChart.Axis,i.labelAngle=0,i.labelPadding=6,i.position=this._isBarChart()?wjcChart.Position.Left:wjcChart.Position.Bottom,i.majorTickMarks=wjcChart.TickMark.None,i.itemsSource=n,i.reversed=r.reversed,i.itemFormatter=function(r,u){var y=n.filter(function(n){return n.value==u.val})[0],s=.5*y.width;if(e._isBarChart()){var v=i.reversed?-1:1,l=i.convert(u.val+s)+5*v,a=i.convert(u.val-s)-5*v,o=i._axrect.left+i._axrect.width-5;r.drawLine(o,l,o,a,t.HRHAXISCSS);r.drawLine(o,l,o+5,l,t.HRHAXISCSS);r.drawLine(o,a,o+5,a,t.HRHAXISCSS);r.drawLine(o,u.pos.y,o-5,u.pos.y,t.HRHAXISCSS)}else{var h=i.convert(u.val-s)+5,c=i.convert(u.val+s)-5,f=i._axrect.top;r.drawLine(h,f,c,f,t.HRHAXISCSS);r.drawLine(h,f,h,f-5,t.HRHAXISCSS);r.drawLine(c,f,c,f-5,t.HRHAXISCSS);r.drawLine(u.pos.x,f,u.pos.x,f+5,t.HRHAXISCSS)}return u},i.min=r.actualMin,i.max=r.actualMax,r.rangeChanged.addHandler(function(){isNaN(i.min)&&isNaN(r.actualMin)||i.min==r.actualMin||(i.min=r.actualMin);isNaN(i.max)&&isNaN(r.actualMax)||i.max==r.actualMax||(i.max=r.actualMax)}),u=new wjcChart.Series,u.visibility=wjcChart.SeriesVisibility.Hidden,this._isBarChart()?u.axisY=i:u.axisX=i,f.series.push(u))},t.prototype._updateFlexPieBinding=function(){this._flexPie.binding=this._colMenu.selectedValue;this._flexPie.refresh()},t.prototype._updatePieInfo=function(){var n=this;this._flexPie&&(this._flexPie._labels=this._flexPie._labels.map(function(t,i){return n._lblsSrc[i].text}))},t.prototype._changeChartType=function(){var n=null;if(this.chartType===PivotChartType.Pie)this._flexPie||this._createFlexPie(),this._updateFlexPie(this._dataItms,this._lblsSrc),this._swapChartAndPie(!1);else{switch(this.chartType){case PivotChartType.Column:n=wjcChart.ChartType.Column;break;case PivotChartType.Bar:n=wjcChart.ChartType.Bar;break;case PivotChartType.Scatter:n=wjcChart.ChartType.Scatter;break;case PivotChartType.Line:n=wjcChart.ChartType.Line;break;case PivotChartType.Area:n=wjcChart.ChartType.Area}this._flexChart?(this._flexChart.hostElement.style.display==='none'||n===PivotChartType.Bar||this._flexChart.chartType===wjcChart.ChartType.Bar)&&this._updateFlexChart(this._dataItms,this._lblsSrc,this._grpLblsSrc):(this._createFlexChart(),this._updateFlexChart(this._dataItms,this._lblsSrc,this._grpLblsSrc));this._flexChart.chartType=n;this._swapChartAndPie(!0)}},t.prototype._swapChartAndPie=function(n){var t=this;this._flexChart&&(this._flexChart.hostElement.style.display=n?'block':'none');this._flexPie&&(this._flexPie.hostElement.style.display=n?'none':'block');this._colMenu&&this._colMenu.hostElement&&(this._colMenu.hostElement.style.display=n?'none':'block',this._colMenu.hostElement.style.top='0',setTimeout(function(){t._colMenu.hostElement.style.top=''},0))},t.prototype._getLabel=function(n){var t='',i,r;if(!n||!n.values)return t;i=n.valueFields?n.valueFields[n._valueFieldIndex]:null;switch(n.values.length){case 0:i&&(t+=i.header);break;case 1:t+=n.getValue(0,!0);i&&(t+='; '+i.header);break;default:for(r=0;r<n.values.length;r++)r>0&&(t+="; "),t+=n.getValue(r,!0);i&&(t+='; '+i.header)}return t},t.prototype._getValue=function(n){var t=this._ng.valueFields[0].format;return t?wjcCore.Globalize.format(n.y,t):n._yfmt},t.prototype._getChartTitle=function(){if(!this.showTitle)return null;var n=this._ng,r=this._getTitle(n.valueFields),u=this._getTitle(n.rowFields),i=this._getTitle(n.columnFields),t='';return this._dataItms.length>0&&(t=wjcCore.format('{value} {by} {rows}',{value:r,by:wjcCore.culture.olap.PivotChart.by,rows:u}),i&&(t+=wjcCore.format(' {and} {cols}',{and:wjcCore.culture.olap.PivotChart.and,cols:i}))),t},t.prototype._getTitle=function(n){for(var t='',i=0;i<n.length;i++)t.length>0&&(t+='; '),t+=n[i].header;return t},t.prototype._isTotalColumn=function(n){var t=n.split(';');return t&&t.length-2<this._ng.columnFields.length?!0:!1},t.prototype._isTotalRow=function(n){return n.values.length<this._ng.rowFields.length?!0:!1},t.prototype._isPieChart=function(){return this._chartType==PivotChartType.Pie},t.prototype._isBarChart=function(){return this._chartType==PivotChartType.Bar},t.prototype._getMergeIndex=function(n,t){var r=-1,i,u,f;if(n!=null&&t!=null&&n.values.length==t.values.length&&n.values.length==n.fields.length&&t.values.length==t.fields.length)for(i=0;i<n.values.length;i++)if(u=n.getValue(i,!0),f=t.getValue(i,!0),u==f)r=i;else return r;return r},t.prototype._getOffsetWidth=function(n){var i=0,t;if(n.length<=1)return i;for(t=0;t<n.length-1;t++)i+=n[t].width;return i},t}(wjcCore.Control);PivotChart.MAX_SERIES=100;PivotChart.MAX_POINTS=100;PivotChart.HRHAXISCSS='wj-hierarchicalaxes-line';exports.PivotChart=PivotChart